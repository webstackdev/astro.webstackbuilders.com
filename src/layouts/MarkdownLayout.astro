---
import { type CollectionEntry, render } from 'astro:content'
import { Image, Picture } from 'astro:assets'
import type { MarkdownHeading } from 'astro'

/**
 * Layout for Markdown/MDX content files
 */
import BaseLayout from '@layouts/BaseLayout.astro'
import Lead from '@components/Layout/Markdown/Lead/index.astro'
import Subtitle from '@components/Layout/Markdown/Subtitle/index.astro'
import Tags from '@components/Layout/Markdown/Tags/index.astro'
import Title from '@components/Layout/Markdown/Title/index.astro'
import Toc from '@components/Toc/index.astro'

/** Components made available for use in MDX */
import Avatar from '@components/Avatar/index.astro'
import Callout from '@components/Callout/index.astro'
import Carousel from '@components/Carousel/index.astro'
import Contact from '@components/CallToAction/Contact/index.astro'
import Copy from '@components/Copy/index.astro'
import Download from '@components/CallToAction/Download/index.astro'
import Embed from '@components/Social/Embed/index.astro'
import Highlighter from '@components/Social/Highlighter/index.astro'
import Icon from '@components/Icon/index.astro'
import List from '@components/List/index.astro'
import MastodonModal from '@components/Social/Mastodon/index.astro'
import Newsletter from '@components/CallToAction/Newsletter/index.astro'
import Shares from '@components/Social/Shares/index.astro'
import Time from '@components/Time/index.astro'
import Testimonials from '@components/Testimonials/index.astro'
import CodeTabs from '@components/Code/CodeTabs/index.astro'

/** Export components for use in MDX */
const Components = {
  Avatar,
  Callout,
  Carousel,
  Contact,
  Copy,
  Download,
  Embed,
  Highlighter,
  Icon,
  Image,
  List,
  MastodonModal,
  Newsletter,
  Picture,
  Shares,
  Testimonials,
  Time,
}

export interface Props {
  /** Author name */
  author?: string
  /** Raw Markdown content from "body" property on content collection */
  collectionItem:
    | CollectionEntry<'articles'>
    | CollectionEntry<'services'>
    | CollectionEntry<'caseStudies'>
    | CollectionEntry<'downloads'>
    | CollectionEntry<'testFixtureCollection'>
  /** Custom CSS class for content wrapper */
  contentClass?: string
  /** Content type for OpenGraph metadata */
  contentType?: 'article' | 'website'
  /** Meta description */
  description: string
  /** Page title shown in <title> and H1 */
  pageTitle: string
  /** URL path component e.g. 'articles/my-article' */
  path: string
  /** Last modified date */
  modifiedDate?: Date
  /** Publication date for articles */
  publishDate?: Date
  /** Estimated reading time */
  readingTime?: string
  /** Specifies the main, high-level category or theme of the article */
  section: string
  /** Whether to show table of contents */
  showToc?: boolean
  /** Hide breadcrumbs on mobile viewports (sm and below) */
  hideBreadcrumbsOnMobile?: boolean
  /** Optional page subtitle or excerpt */
  subtitle?: string
  /** Content tags */
  tags?: string[]
}

const {
  author,
  collectionItem,
  contentClass = '',
  contentType = 'article',
  description,
  hideBreadcrumbsOnMobile = false,
  modifiedDate,
  pageTitle,
  path,
  publishDate,
  readingTime,
  showToc,
  subtitle,
  tags,
} = Astro.props

// Schema.org itemtype based on content type
const schemaType =
  contentType === 'article' ? 'http://schema.org/Article' : 'http://schema.org/WebPage'

const { Content, headings = [] } = await render(collectionItem)
const tocHeadings: MarkdownHeading[] = headings.filter(heading => heading.depth > 1)
const shouldRenderToc = showToc !== false && tocHeadings.length > 0
---

<BaseLayout
  pageTitle={pageTitle}
  path={path}
  description={description}
  contentType={contentType}
  hideBreadcrumbsOnMobile={hideBreadcrumbsOnMobile}
  {...publishDate && { publishDate }}
  {...modifiedDate && { modifiedDate }}
  {...author && { author }}
  {...tags && { tags }}
>
  <article
    class={`mx-auto py-4 ${contentClass}`}
    itemscope
    itemtype={schemaType}
    aria-labelledby="article-title"
  >
    <header class="mb-4 sm:mb-6">
      {tags && tags.length > 0 && (
        <div class="mb-2">
          <Tags tags={tags} />
        </div>
      )}
      <Title pageTitle={pageTitle} />
      {subtitle && <Subtitle subtitle={subtitle} />}
      {
        (modifiedDate || publishDate || author || readingTime) && (
          <Lead
            {...(author && { author })}
            {...(modifiedDate && { modifiedDate })}
            {...(publishDate && { publishDate })}
            {...(readingTime && { readingTime })}
          />
        )
      }
    </header>

    {/** SLOT: hero-image, conditional on image specified */}
    <slot name="hero-image" />

    {/** SLOT: content-prefix, renders prior to markdown body (e.g., metadata panels) */}
    <slot name="content-prefix" />

    {/** SLOT: default (unnamed) */}
    <div
      id="content"
      class={`${shouldRenderToc ? 'grid gap-8 lg:grid-cols-[1fr_250px]' : 'flex flex-col gap-8'}`}
      itemprop="articleBody"
    >
      <div class="markdown-content__prose min-w-0 leading-relaxed">
        <Content components={{ ...Components }} />
      </div>
      {shouldRenderToc && <Toc items={tocHeadings} />}
    </div>

    {/** SLOT: after-content, includes social shares and web mentions */}
    <slot name="after-content" />
  </article>

  {/** SLOT: related-content, renders a suggested content carousel */}
  <slot name="related-content" />

  <!-- Mastodon sharing modal for Highlighter, hidden except on hover -->
  <MastodonModal />

  <!-- Registers the <code-tabs> web component for markdown-emitted markup -->
  <CodeTabs />
</BaseLayout>
