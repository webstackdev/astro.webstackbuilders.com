---
import BaseLayout from '@layouts/BaseLayout.astro'
import {
  getPackageRelease,
  getPrivacyPolicyVersion,
  isDev,
  isE2eTest,
  isProd,
  isTest,
  isUnitTest,
} from '@pages/api/_environment/environmentApi'

/**
 * This testing page intentionally renders as part of the client bundle so
 * Playwright can verify the statically generated output.
 */
export const prerender = true

const pageTitle = 'Environment API Diagnostics'
const pageDescription = 'Server environment helper snapshot for automated testing only.'
const pagePath = '/testing/environment-api'

const snapshot = {
  isUnitTest: isUnitTest(),
  isTest: isTest(),
  isE2eTest: isE2eTest(),
  isDev: isDev(),
  isProd: isProd(),
  packageRelease: getPackageRelease(),
  privacyPolicyVersion: getPrivacyPolicyVersion(),
}

const formattedSnapshot = JSON.stringify(snapshot, null, 2)
const scriptContent = `window.environmentApiSnapshot = ${JSON.stringify(snapshot).replace(/</g, '\\u003c')}`
---

<BaseLayout pageTitle={pageTitle} path={pagePath} description={pageDescription} noindex>
  <section class="mx-auto mb-6 max-w-3xl space-y-3 text-lg text-offset">
    <p>
      Use this fixture to validate the server-side environment helpers without relying on marketing pages.
    </p>
    <p data-testid="environment-api-notice">
      The JSON payload below mirrors the runtime snapshot that client scripts can also read via
      <code>window.environmentApiSnapshot</code>.
    </p>
  </section>

  <section class="mx-auto max-w-3xl">
    <pre
      id="environment-api-json"
      class="overflow-auto rounded border border-border bg-bg-offset p-4 font-mono text-sm text-text"
    >{formattedSnapshot}</pre>
  </section>

  <script type="module" is:inline set:html={scriptContent}></script>
</BaseLayout>
