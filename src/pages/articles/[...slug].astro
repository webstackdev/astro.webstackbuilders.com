---
import { type CollectionEntry, getCollection, getEntry } from 'astro:content'
import { Picture } from 'astro:assets'
import { isDev } from '@lib/config/environmentServer'
import MarkdownLayout from '@layouts/MarkdownLayout.astro'
import Shares from '@components/Social/Shares/index.astro'
import Carousel from '@components/Carousel/index.astro'
import WebMentions from '@components/WebMentions/index.astro'

export interface Props {
  article: CollectionEntry<'articles'>
}

/** Generate static paths for all articles */
export async function getStaticPaths() {
  const articleEntries = await getCollection('articles', ({ data }) => {
    return isDev() || data.isDraft !== true
  })
  return articleEntries.map(article => ({
    params: { slug: article.id },
    props: { article },
  }))
}

const { article } = Astro.props
const author = await getEntry(article.data.author)

const path = `/articles/${article.id}`
const section = `Articles`
---

<MarkdownLayout
  author={author.data.name}
  collectionItem={article}
  contentType="article"
  description={article.data.description}
  pageTitle={article.data.title}
  path={path}
  publishDate={article.data.publishDate}
  section={section}
  showToc={article.data.showToc ?? true}
  tags={article.data.tags}
  {...(article.data.readingTime && { readingTime: article.data.readingTime })}
>
  {/** SLOT: hero-image */}
  {
    article.data.cover && (
      <div
        class="relative aspect-video max-w-3xl mx-auto rounded-2xl overflow-hidden shadow-lg mb-8"
        slot="hero-image"
      >
        <Picture
          src={article.data.cover}
          alt={article.data.coverAlt}
          widths={[320, 640, 960, 1280]}
          sizes="(min-width: 1024px) 66vw, 100vw"
          formats={['avif', 'webp', 'jpeg']}
          layout="constrained"
          fit="cover"
          position="center"
          class="absolute inset-0 h-full w-full"
        />
      </div>
    )
  }

  {/** SLOT: after-content */}
  <section
    class="border-t border-border pt-8 mt-12"
    aria-labelledby="article-share-title"
    slot="after-content"
  >
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-6">
      <div>
        <h2 class="text-lg font-semibold text-text mb-2" id="article-share-title">
          Share this article
        </h2>
        <p class="text-text-offset text-sm">
          Found this helpful? Share it with others who might benefit.
        </p>
      </div>
      <Shares
        url={`https://www.webstackbuilders.com${path}`}
        title={article.data.title}
        description={`Read "${article.data.title}" on Webstack Builders`}
        class="shrink-0"
      />
    </div>
    <WebMentions url={`https://www.webstackbuilders.com${path}`} />
  </section>

  {/** SLOT: related-content */}
  <section
    class="border-t border-border pt-8 mt-12"
    aria-labelledby="article-related-title"
    slot="related-content"
  >
    <header class="mb-8">
      <h2 class="text-2xl font-bold text-text" id="article-related-title">Other things I've written</h2>
    </header>
    <Carousel title="" variant="suggested" currentSlug={article.id} limit={5} type="articles" />
  </section>
</MarkdownLayout>
