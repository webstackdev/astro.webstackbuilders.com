---
import { type CollectionEntry, getCollection } from 'astro:content'
import { isDev, isProd } from '@components/scripts/utils/environmentClient'
import MarkdownLayout, { Shares, Carousel } from '@layouts/MarkdownLayout.astro'
import { WebMentions } from '@components/WebMentions'

export interface Props {
  article: CollectionEntry<'articles'>
}

/** Generate static paths for all articles */
export async function getStaticPaths() {
  const articleEntries = await getCollection('articles', ({ data }) => {
    return isDev() || (isProd() && data.isDraft !== true)
  })
  return articleEntries.map(article => ({
    params: { slug: article.id },
    props: { article },
  }))
}

const { article } = Astro.props
const renderedContent = article.rendered?.html || article.body || 'Content not available'
const path = `/articles/${article.id}`
const pageTitle = article.data.title
const cover = article.data.image
const authorId =
  typeof article.data.author === 'string' ? article.data.author : article.data.author.id
---

<MarkdownLayout
  pageTitle={pageTitle}
  path={path}
  contentType="article"
  publishDate={article.data.publishDate}
  author={authorId}
  section="Technology"
  tags={article.data.tags}
  description={article.data.description}
  {...(cover?.src && { image: cover.src })}
  {...(article.data.readingTime && { readingTime: article.data.readingTime })}
  showToc={false}
>
  {
    cover && (
      <div
        class="aspect-video max-w-3xl mx-auto rounded-2xl overflow-hidden shadow-lg mb-8"
        slot="hero-image"
      >
        <img src={cover.src} alt={cover.alt} loading="eager" class="w-full h-full object-cover" />
      </div>
    )
  }

  <div set:html={renderedContent} />

  <div class="border-t border-[var(--color-border)] pt-8 mt-12" slot="after-content">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-6">
      <div>
        <h3 class="text-lg font-semibold text-[var(--color-text)] mb-2">
          Share this article
        </h3>
        <p class="text-[var(--color-text-offset)] text-sm">
          Found this helpful? Share it with others who might benefit.
        </p>
      </div>
      <Shares
        url={`https://webstackbuilders.com${path}`}
        title={pageTitle}
        description={`Read "${pageTitle}" on Webstack Builders`}
        class="flex-shrink-0"
      />
    </div>

    {/* WebMentions - shows mentions, likes, and reposts from across the web */}
    <WebMentions url={`https://webstackbuilders.com${path}`} />
  </div>

  <div class="border-t border-[var(--color-border)] pt-8 mt-12" slot="related-content">
    <header class="mb-8">
      <h3 class="text-2xl font-bold text-[var(--color-text)]">Other things I've written</h3>
    </header>
    <Carousel title="" variant="suggested" currentSlug={article.id} limit={5} type="articles" />
  </div>
</MarkdownLayout>
