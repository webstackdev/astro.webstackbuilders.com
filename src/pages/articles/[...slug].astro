---
import { type CollectionEntry, getCollection } from 'astro:content'
import { Picture } from 'astro:assets'
import { isDev, isProd } from '@lib/config/environmentServer'
import MarkdownLayout from '@layouts/MarkdownLayout.astro'
import Shares from '@components/Social/Shares/index.astro'
import Carousel from '@components/Carousel/index.astro'
import WebMentions from '@components/WebMentions/index.astro'

export interface Props {
  article: CollectionEntry<'articles'>
}

/** Generate static paths for all articles */
export async function getStaticPaths() {
  const articleEntries = await getCollection('articles', ({ data }) => {
    return isDev() || (isProd() && data.isDraft !== true)
  })
  return articleEntries.map(article => ({
    params: { slug: article.id },
    props: { article },
  }))
}

const { article } = Astro.props

const path = `/articles/${article.id}`
const pageTitle = article.data.title
const cover = article.data.cover
const authorId =
  typeof article.data.author === 'string' ? article.data.author : article.data.author.id
---

<MarkdownLayout
  pageTitle={pageTitle}
  path={path}
  contentType="article"
  collectionItem={article}
  publishDate={article.data.publishDate}
  author={authorId}
  tags={article.data.tags}
  description={article.data.description}
  {...(cover?.src && { image: cover.src })}
  {...(article.data.readingTime && { readingTime: article.data.readingTime })}
  showToc={article.data.showToc ?? true}
>
  {/** SLOT: hero-image */}
  {
    cover && (
      <div
        class="relative aspect-video max-w-3xl mx-auto rounded-2xl overflow-hidden shadow-lg mb-8"
        slot="hero-image"
      >
        <Picture
          src={cover.src}
          alt={cover.alt}
          widths={[320, 640, 960, 1280]}
          sizes="(min-width: 1024px) 66vw, 100vw"
          formats={['avif', 'webp', 'jpeg']}
          layout="constrained"
          fit="cover"
          position="center"
          class="absolute inset-0 h-full w-full"
        />
      </div>
    )
  }

  {/** SLOT: after-content */}
  <div class="border-t border-border pt-8 mt-12" slot="after-content">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-6">
      <div>
        <h3 class="text-lg font-semibold text-text mb-2">
          Share this article
        </h3>
        <p class="text-text-offset text-sm">
          Found this helpful? Share it with others who might benefit.
        </p>
      </div>
      <Shares
        url={`https://webstackbuilders.com${path}`}
        title={pageTitle}
        description={`Read "${pageTitle}" on Webstack Builders`}
        class="shrink-0"
      />
    </div>
    <WebMentions url={`https://webstackbuilders.com${path}`} />
  </div>

  {/** SLOT: related-content */}
  <div class="border-t border-border pt-8 mt-12" slot="related-content">
    <header class="mb-8">
      <h3 class="text-2xl font-bold text-text">Other things I've written</h3>
    </header>
    <Carousel title="" variant="suggested" currentSlug={article.id} limit={5} type="articles" />
  </div>
</MarkdownLayout>
