---
import BaseLayout from '@layouts/BaseLayout.astro'

const pageTitle = 'My Data - Privacy Rights'
const path = 'privacy/my-data'
const description = 'Exercise your GDPR rights by requesting a copy of your data or asking us to delete it.'

// Get status from query params
const status = Astro.url.searchParams.get('status')

const statusMessages: Record<string, { type: 'success' | 'error' | 'info', message: string }> = {
  'sent': { type: 'success', message: 'Verification email sent! Please check your inbox and click the link to complete your request.' },
  'invalid': { type: 'error', message: 'Invalid or expired verification link. Please submit a new request.' },
  'expired': { type: 'error', message: 'This verification link has expired. Please submit a new request.' },
  'already-completed': { type: 'info', message: 'This request has already been completed.' },
  'deleted': { type: 'success', message: 'Your data has been successfully deleted from our systems.' },
  'error': { type: 'error', message: 'An error occurred. Please try again or contact support.' }
}
---

<BaseLayout pageTitle={pageTitle} path={path} description={description}>
  <div class="privacy-page">
    <h1>My Data & Privacy Rights</h1>

    {status && statusMessages[status] && (
      <div
        id="status-message"
        tabindex="-1"
        role={statusMessages[status].type === 'error' ? 'alert' : 'status'}
        aria-live={statusMessages[status].type === 'error' ? 'assertive' : 'polite'}
        aria-atomic="true"
        class:list={[
        'alert',
        statusMessages[status].type === 'success' && 'alert-success',
        statusMessages[status].type === 'error' && 'alert-error',
        statusMessages[status].type === 'info' && 'alert-info'
      ]}>
        {statusMessages[status].message}
      </div>
    )}

    <section class="intro" aria-labelledby="my-data-intro-title">
      <h2 class="sr-only" id="my-data-intro-title">Overview</h2>
      <p>
        Under GDPR, you have the right to access and control your personal data.
        Use the forms below to request a copy of your data or request its deletion.
      </p>
    </section>

    <div class="data-requests">
      <!-- Access Data Request -->
      <section class="request-card" aria-labelledby="my-data-access-title">
        <h2 id="my-data-access-title">
          <span aria-hidden="true">üì•</span> Access My Data
        </h2>
        <p>Request a copy of all personal data we have about you, including consent records and newsletter subscriptions.</p>

        <form id="access-form" class="data-form">
          <div class="form-group">
            <label for="access-email">Email Address</label>
            <input
              type="email"
              id="access-email"
              name="email"
              required
              placeholder="your@email.com"
            />
          </div>

          <button type="submit" class="btn btn-primary">
            Request My Data
          </button>

          <div
            id="access-message"
            class="form-message"
            role="status"
            aria-live="polite"
            aria-atomic="true"
            tabindex="-1"
          ></div>
        </form>
      </section>

      <!-- Delete Data Request -->
      <section class="request-card" aria-labelledby="my-data-delete-title">
        <h2 id="my-data-delete-title">
          <span aria-hidden="true">üóëÔ∏è</span> Delete My Data
        </h2>
        <p class="warning">
          <strong><span aria-hidden="true">‚ö†Ô∏è</span> Warning:</strong> This will permanently delete all your data from our systems. This action cannot be undone.
        </p>

        <form id="delete-form" class="data-form">
          <div class="form-group">
            <label for="delete-email">Email Address</label>
            <input
              type="email"
              id="delete-email"
              name="email"
              required
              placeholder="your@email.com"
            />
          </div>

          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" id="confirm-delete" required />
              I understand this will permanently delete all my data
            </label>
          </div>

          <button type="submit" class="btn btn-danger">
            Delete My Data
          </button>

          <div
            id="delete-message"
            class="form-message"
            role="status"
            aria-live="polite"
            aria-atomic="true"
            tabindex="-1"
          ></div>
        </form>
      </section>
    </div>

    <section class="info" aria-labelledby="my-data-next-title">
      <h2 id="my-data-next-title">What Happens Next?</h2>
      <ol>
        <li><strong>Verification Email:</strong> We'll send a verification link to your email address.</li>
        <li><strong>Click the Link:</strong> Click the link in the email to verify your request (expires in 24 hours).</li>
        <li><strong>For Access Requests:</strong> Your data will be automatically downloaded as a JSON file.</li>
        <li><strong>For Deletion Requests:</strong> Your data will be permanently removed and you'll see a confirmation.</li>
      </ol>
    </section>
  </div>
</BaseLayout>

<script>
  const statusMessage = document.getElementById('status-message')

  if (statusMessage instanceof HTMLElement) {
    statusMessage.focus()
  }

  function setMessage(
    accessibleEl: HTMLElement | null,
    message: string,
    type: 'success' | 'error' | 'info'
  ) {
    if (!(accessibleEl instanceof HTMLElement)) return

    accessibleEl.setAttribute('role', type === 'error' ? 'alert' : 'status')
    accessibleEl.setAttribute('aria-live', type === 'error' ? 'assertive' : 'polite')
    accessibleEl.textContent = message
    accessibleEl.className = `form-message ${type}`
    accessibleEl.focus()
  }

  // Handle access data form
  const accessForm = document.getElementById('access-form')
  const accessMessage = document.getElementById('access-message')

  accessForm?.addEventListener('submit', async (e) => {
    e.preventDefault()

    if (!(accessForm instanceof HTMLFormElement) || !(accessMessage instanceof HTMLElement)) return

    const formData = new FormData(accessForm)
    const email = formData.get('email') as string

    setMessage(accessMessage, 'Sending request...', 'info')

    try {
      const response = await fetch('/api/gdpr/request-data', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          email,
          requestType: 'ACCESS'
        })
      })

      const data = await response.json()

      if (data.success) {
        setMessage(accessMessage, data.message, 'success')
        accessForm.reset()
      } else {
        setMessage(accessMessage, data.error?.message || 'Request failed', 'error')
      }
    } catch {
      setMessage(accessMessage, 'Network error. Please try again.', 'error')
    }
  })

  // Handle delete data form
  const deleteForm = document.getElementById('delete-form')
  const deleteMessage = document.getElementById('delete-message')

  deleteForm?.addEventListener('submit', async (e) => {
    e.preventDefault()

    if (!(deleteForm instanceof HTMLFormElement) || !(deleteMessage instanceof HTMLElement)) return

    const formData = new FormData(deleteForm)
    const email = formData.get('email') as string

    setMessage(deleteMessage, 'Sending request...', 'info')

    try {
      const response = await fetch('/api/gdpr/request-data', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          email,
          requestType: 'DELETE'
        })
      })

      const data = await response.json()

      if (data.success) {
        setMessage(deleteMessage, data.message, 'success')
        deleteForm.reset()
      } else {
        setMessage(deleteMessage, data.error?.message || 'Request failed', 'error')
      }
    } catch {
      setMessage(deleteMessage, 'Network error. Please try again.', 'error')
    }
  })
</script>

<style>
  .intro {
    background: var(--color-background-secondary);
    border-radius: 8px;
    margin-bottom: 2rem;
    padding: 1.5rem;
  }

  .alert {
    border-left: 4px solid;
    border-radius: 4px;
    margin-bottom: 1.5rem;
    padding: 1rem;
  }

  .alert-success {
    background: #d4edda;
    border-color: #28a745;
    color: #155724;
  }

  .alert-error {
    background: #f8d7da;
    border-color: #dc3545;
    color: #721c24;
  }

  .alert-info {
    background: #d1ecf1;
    border-color: #17a2b8;
    color: #0c5460;
  }

  .data-requests {
    display: grid;
    gap: 2rem;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    margin: 2rem 0;
  }

  .request-card {
    background: var(--color-background);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    padding: 2rem;
  }

  .request-card h2 {
    margin-top: 0;
  }

  .warning {
    background: #fff3cd;
    border-left: 4px solid #ffc107;
    margin: 1rem 0;
    padding: 1rem;
  }

  .data-form {
    margin-top: 1.5rem;
  }

  .form-group {
    margin-bottom: 1rem;
  }

  .form-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 0.5rem;
  }

  .form-group input[type="email"] {
    border: 1px solid var(--color-border);
    border-radius: 4px;
    padding: 0.5rem;
    width: 100%;
  }

  .checkbox-label {
    align-items: center;
    display: flex;
    font-weight: normal !important;
    gap: 0.5rem;
  }

  .checkbox-label input[type="checkbox"] {
    width: auto;
  }

  .btn {
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 600;
    padding: 0.75rem 1.5rem;
    transition: background-color 0.2s;
  }

  .btn-primary {
    background: var(--color-primary);
    color: white;
  }

  .btn-primary:hover {
    background: var(--color-primary-dark);
  }

  .btn-danger {
    background: #dc3545;
    color: white;
  }

  .btn-danger:hover {
    background: #c82333;
  }

  .form-message {
    border-radius: 4px;
    display: none;
    margin-top: 1rem;
    padding: 0.75rem;
  }

  .form-message.success {
    background: #d4edda;
    color: #155724;
    display: block;
  }

  .form-message.error {
    background: #f8d7da;
    color: #721c24;
    display: block;
  }

  .form-message.info {
    background: #d1ecf1;
    color: #0c5460;
    display: block;
  }

  .info {
    background: var(--color-background-secondary);
    border-radius: 8px;
    margin-top: 3rem;
    padding: 2rem;
  }

  .info ol {
    margin-top: 1rem;
  }

  .info li {
    margin-bottom: 0.75rem;
  }
</style>
