---
import BaseLayout from '@layouts/BaseLayout.astro'

const pageTitle = 'My Data - Privacy Rights'
const path = 'privacy/my-data'

// Get status from query params
const status = Astro.url.searchParams.get('status')

const statusMessages: Record<string, { type: 'success' | 'error' | 'info', message: string }> = {
  'sent': { type: 'success', message: 'Verification email sent! Please check your inbox and click the link to complete your request.' },
  'invalid': { type: 'error', message: 'Invalid or expired verification link. Please submit a new request.' },
  'expired': { type: 'error', message: 'This verification link has expired. Please submit a new request.' },
  'already-completed': { type: 'info', message: 'This request has already been completed.' },
  'deleted': { type: 'success', message: 'Your data has been successfully deleted from our systems.' },
  'error': { type: 'error', message: 'An error occurred. Please try again or contact support.' }
}
---

<BaseLayout pageTitle={pageTitle} path={path}>
  <div class="privacy-page">
    <h1>My Data & Privacy Rights</h1>

    {status && statusMessages[status] && (
      <div class:list={[
        'alert',
        statusMessages[status].type === 'success' && 'alert-success',
        statusMessages[status].type === 'error' && 'alert-error',
        statusMessages[status].type === 'info' && 'alert-info'
      ]}>
        {statusMessages[status].message}
      </div>
    )}

    <section class="intro">
      <p>
        Under GDPR, you have the right to access and control your personal data.
        Use the forms below to request a copy of your data or request its deletion.
      </p>
    </section>

    <div class="data-requests">
      <!-- Access Data Request -->
      <section class="request-card">
        <h2>üì• Access My Data</h2>
        <p>Request a copy of all personal data we have about you, including consent records and newsletter subscriptions.</p>

        <form id="access-form" class="data-form">
          <div class="form-group">
            <label for="access-email">Email Address</label>
            <input
              type="email"
              id="access-email"
              name="email"
              required
              placeholder="your@email.com"
            />
          </div>

          <button type="submit" class="btn btn-primary">
            Request My Data
          </button>

          <div id="access-message" class="form-message" role="alert" aria-live="polite"></div>
        </form>
      </section>

      <!-- Delete Data Request -->
      <section class="request-card">
        <h2>üóëÔ∏è Delete My Data</h2>
        <p class="warning">
          <strong>‚ö†Ô∏è Warning:</strong> This will permanently delete all your data from our systems. This action cannot be undone.
        </p>

        <form id="delete-form" class="data-form">
          <div class="form-group">
            <label for="delete-email">Email Address</label>
            <input
              type="email"
              id="delete-email"
              name="email"
              required
              placeholder="your@email.com"
            />
          </div>

          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" id="confirm-delete" required />
              I understand this will permanently delete all my data
            </label>
          </div>

          <button type="submit" class="btn btn-danger">
            Delete My Data
          </button>

          <div id="delete-message" class="form-message" role="alert" aria-live="polite"></div>
        </form>
      </section>
    </div>

    <section class="info">
      <h2>What Happens Next?</h2>
      <ol>
        <li><strong>Verification Email:</strong> We'll send a verification link to your email address.</li>
        <li><strong>Click the Link:</strong> Click the link in the email to verify your request (expires in 24 hours).</li>
        <li><strong>For Access Requests:</strong> Your data will be automatically downloaded as a JSON file.</li>
        <li><strong>For Deletion Requests:</strong> Your data will be permanently removed and you'll see a confirmation.</li>
      </ol>
    </section>
  </div>
</BaseLayout>

<script>
  // Handle access data form
  const accessForm = document.getElementById('access-form')
  const accessMessage = document.getElementById('access-message')

  accessForm?.addEventListener('submit', async (e) => {
    e.preventDefault()

    if (!(accessForm instanceof HTMLFormElement) || !(accessMessage instanceof HTMLElement)) return

    const formData = new FormData(accessForm)
    const email = formData.get('email') as string

    accessMessage.textContent = 'Sending request...'
    accessMessage.className = 'form-message info'

    try {
      const response = await fetch('/api/gdpr/request-data', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          email,
          requestType: 'ACCESS'
        })
      })

      const data = await response.json()

      if (data.success) {
        accessMessage.textContent = data.message
        accessMessage.className = 'form-message success'
        accessForm.reset()
      } else {
        accessMessage.textContent = data.error?.message || 'Request failed'
        accessMessage.className = 'form-message error'
      }
    } catch {
      accessMessage.textContent = 'Network error. Please try again.'
      accessMessage.className = 'form-message error'
    }
  })

  // Handle delete data form
  const deleteForm = document.getElementById('delete-form')
  const deleteMessage = document.getElementById('delete-message')

  deleteForm?.addEventListener('submit', async (e) => {
    e.preventDefault()

    if (!(deleteForm instanceof HTMLFormElement) || !(deleteMessage instanceof HTMLElement)) return

    const formData = new FormData(deleteForm)
    const email = formData.get('email') as string

    deleteMessage.textContent = 'Sending request...'
    deleteMessage.className = 'form-message info'

    try {
      const response = await fetch('/api/gdpr/request-data', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          email,
          requestType: 'DELETE'
        })
      })

      const data = await response.json()

      if (data.success) {
        deleteMessage.textContent = data.message
        deleteMessage.className = 'form-message success'
        deleteForm.reset()
      } else {
        deleteMessage.textContent = data.error?.message || 'Request failed'
        deleteMessage.className = 'form-message error'
      }
    } catch {
      deleteMessage.textContent = 'Network error. Please try again.'
      deleteMessage.className = 'form-message error'
    }
  })
</script>

<style>
  .intro {
    margin-bottom: 2rem;
    padding: 1.5rem;
    background: var(--color-background-secondary);
    border-radius: 8px;
  }

  .alert {
    padding: 1rem;
    margin-bottom: 1.5rem;
    border-radius: 4px;
    border-left: 4px solid;
  }

  .alert-success {
    background: #d4edda;
    border-color: #28a745;
    color: #155724;
  }

  .alert-error {
    background: #f8d7da;
    border-color: #dc3545;
    color: #721c24;
  }

  .alert-info {
    background: #d1ecf1;
    border-color: #17a2b8;
    color: #0c5460;
  }

  .data-requests {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2rem;
    margin: 2rem 0;
  }

  .request-card {
    padding: 2rem;
    border: 1px solid var(--color-border);
    border-radius: 8px;
    background: var(--color-background);
  }

  .request-card h2 {
    margin-top: 0;
  }

  .warning {
    padding: 1rem;
    background: #fff3cd;
    border-left: 4px solid #ffc107;
    margin: 1rem 0;
  }

  .data-form {
    margin-top: 1.5rem;
  }

  .form-group {
    margin-bottom: 1rem;
  }

  .form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
  }

  .form-group input[type="email"] {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid var(--color-border);
    border-radius: 4px;
  }

  .checkbox-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: normal !important;
  }

  .checkbox-label input[type="checkbox"] {
    width: auto;
  }

  .btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 4px;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.2s;
  }

  .btn-primary {
    background: var(--color-primary);
    color: white;
  }

  .btn-primary:hover {
    background: var(--color-primary-dark);
  }

  .btn-danger {
    background: #dc3545;
    color: white;
  }

  .btn-danger:hover {
    background: #c82333;
  }

  .form-message {
    margin-top: 1rem;
    padding: 0.75rem;
    border-radius: 4px;
    display: none;
  }

  .form-message.success {
    display: block;
    background: #d4edda;
    color: #155724;
  }

  .form-message.error {
    display: block;
    background: #f8d7da;
    color: #721c24;
  }

  .form-message.info {
    display: block;
    background: #d1ecf1;
    color: #0c5460;
  }

  .info {
    margin-top: 3rem;
    padding: 2rem;
    background: var(--color-background-secondary);
    border-radius: 8px;
  }

  .info ol {
    margin-top: 1rem;
  }

  .info li {
    margin-bottom: 0.75rem;
  }
</style>
