---
import { type CollectionEntry, getCollection } from 'astro:content'
import { Picture } from 'astro:assets'
import { isDev, isProd } from '@lib/config/environmentServer'
import BaseLayout from '@layouts/BaseLayout.astro'
import { exceptions } from '@content/_tagList'

export interface Params {
  tag: string
}

type ContentItem =
  | (CollectionEntry<'articles'> & { type: 'article' })
  | (CollectionEntry<'caseStudies'> & { type: 'case-study' })
  | (CollectionEntry<'services'> & { type: 'service' })
  | (CollectionEntry<'downloads'> & { type: 'download' })

export interface Props {
  content: ContentItem[]
}

export async function getStaticPaths() {
  // Get all content collections with tags
  const allArticles = await getCollection('articles', ({ data }) => {
    return isDev() || (isProd() && data.isDraft !== true)
  })

  const allCaseStudies = await getCollection('caseStudies', ({ data }) => {
    return isDev() || (isProd() && data.isDraft !== true)
  })
  const allServices = await getCollection('services', ({ data }) => {
    return isDev() || (isProd() && data.isDraft !== true)
  })
  const allDownloads = await getCollection('downloads', ({ data }) => {
    return isDev() || (isProd() && data.isDraft !== true)
  })

  // Combine all content and extract unique tags
  const allContent = [
    ...allArticles.map(item => ({ ...item, type: 'article' })),
    ...allCaseStudies.map(item => ({ ...item, type: 'case-study' })),
    ...allServices.map(item => ({ ...item, type: 'service' })),
    ...allDownloads.map(item => ({ ...item, type: 'download' })),
  ]

  const uniqueTags = [...new Set(allContent.map(item => item.data.tags).flat())]

  return uniqueTags.map(tag => {
    const filteredContent = allContent.filter(item => item.data.tags.includes(tag))
    return {
      params: { tag },
      props: { content: filteredContent },
    }
  })
}

const { tag } = Astro.params
const { content: allTagContent } = Astro.props

// Pagination setup
const ITEMS_PER_PAGE = 12
const currentPage = parseInt(Astro.url.searchParams.get('page') || '1')
const totalItems = allTagContent.length
const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE)
const startIndex = (currentPage - 1) * ITEMS_PER_PAGE
const endIndex = startIndex + ITEMS_PER_PAGE

// Sort by publish date (newest first) and paginate
const sortedContent = allTagContent.sort(
  (a, b) => new Date(b.data.publishDate).getTime() - new Date(a.data.publishDate).getTime()
)

const paginatedContent = sortedContent.slice(startIndex, endIndex)

// Function to get display name for tags
const getTagDisplayName = (tag: string) => {
  return exceptions[tag as keyof typeof exceptions] || tag
}

const typeMetadata = {
  article: { label: 'Article', badgeClass: 'bg-primary', hrefBase: 'articles' },
  'case-study': { label: 'Case Study', badgeClass: 'bg-success', hrefBase: 'case-studies' },
  service: { label: 'Service', badgeClass: 'bg-accent', hrefBase: 'services' },
  download: { label: 'Download', badgeClass: 'bg-secondary', hrefBase: 'downloads' },
} as const

const displayName = getTagDisplayName(tag)
const path = `/tags/${tag}`
const pageDescription = `List of content tagged with ${displayName}`
const pageTitle = `${displayName} - Tag`
const breadcrumbTitle = displayName
const section = 'Tags'
---

<BaseLayout
  pageTitle={pageTitle}
  path={path}
  description={pageDescription}
  breadcrumbTitle={breadcrumbTitle}
  section={section}
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <header class="text-center mb-12">
      <h1 class="text-4xl md:text-5xl font-bold text-text mb-4">
        {displayName}
      </h1>
      <p class="text-xl text-text-muted">
        {totalItems} item{totalItems !== 1 ? 's' : ''} tagged with {displayName.toLowerCase()}
      </p>
      <nav class="mt-4">
        <a href="/tags" class="text-primary hover:underline">
          ← Browse all tags
        </a>
      </nav>
    </header>

    {
      paginatedContent.length > 0 ? (
        <>
          <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 lg:gap-12 mb-12">
            {paginatedContent.map(item => {
              const typeMeta = typeMetadata[item.type]
              const href = `/${typeMeta.hrefBase}/${item.id}`

              return (
                <article class="bg-bg rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 hover:-translate-y-1 overflow-hidden group">
                  <a href={href} class="block h-full">
                    {item.data.cover && (
                      <div class="relative aspect-video overflow-hidden">
                        <Picture
                          src={item.data.cover}
                          alt={item.data.coverAlt}
                          widths={[320, 640, 960, 1280]}
                          sizes="(min-width: 1280px) 33vw, (min-width: 768px) 50vw, 100vw"
                          formats={['avif', 'webp', 'jpeg']}
                          layout="constrained"
                          fit="cover"
                          position="center"
                          class="absolute inset-0 h-full w-full object-cover group-hover:scale-105 transition-transform duration-300"
                          loading="lazy"
                        />
                      </div>
                    )}

                    <div class="p-6 space-y-4">
                      <div class="flex items-center gap-3 text-sm">
                        <span
                          class={`px-3 py-1 rounded-full text-white font-medium ${typeMeta.badgeClass}`}
                        >
                          {typeMeta.label}
                        </span>
                        <time class="text-text-muted">
                          {item.data.publishDate.toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric',
                          })}
                        </time>
                      </div>

                      <h2 class="text-xl font-semibold text-text leading-tight group-hover:text-primary transition-colors duration-300">
                        {item.data.title}
                      </h2>

                      {item.data.description && (
                        <p class="text-text-muted text-sm leading-relaxed line-clamp-3">
                          {item.data.description}
                        </p>
                      )}

                      <div class="space-y-3 pt-2">
                        {/* Client or Author info */}
                        {'client' in item.data && item.data.client && (
                          <span class="inline-block text-sm font-medium text-primary bg-primary-bg px-3 py-1 rounded-full">
                            Client: {item.data.client}
                          </span>
                        )}

                        {/* Additional tags */}
                        {item.data.tags && item.data.tags.length > 1 && (
                          <div class="flex flex-wrap gap-2">
                            {item.data.tags
                              .filter((t: string) => t !== tag)
                              .slice(0, 3)
                              .map((relatedTag: string) => (
                                <a
                                  href={`/tags/${relatedTag}`}
                                  class="text-xs font-medium text-text-muted bg-bg-offset hover:bg-border px-2 py-1 rounded-full transition-colors duration-200"
                                >
                                  {getTagDisplayName(relatedTag)}
                                </a>
                              ))}
                          </div>
                        )}
                      </div>
                    </div>
                  </a>
                </article>
              )
            })}
          </section>

          {/* Pagination */}
          {totalPages > 1 && (
            <nav class="flex flex-wrap justify-center items-center gap-2" aria-label="Pagination">
              {currentPage > 1 && (
                <a
                  href={currentPage === 2 ? path : `${path}?page=${currentPage - 1}`}
                  class="px-4 py-2 text-sm font-medium text-text bg-bg border border-border rounded-lg hover:bg-bg-offset transition-colors duration-200"
                >
                  ← Previous
                </a>
              )}

              {/* Show first page */}
              {currentPage > 3 && (
                <>
                  <a
                    href={path}
                    class="px-3 py-2 text-sm font-medium text-text bg-bg border border-border rounded-lg hover:bg-bg-offset transition-colors duration-200"
                  >
                    1
                  </a>
                  {currentPage > 4 && (
                    <span class="px-3 py-2 text-sm text-text-muted">…</span>
                  )}
                </>
              )}

              {/* Show pages around current page */}
              {Array.from({ length: Math.min(5, totalPages) }, (_, i) => {
                const startPage = Math.max(1, Math.min(currentPage - 2, totalPages - 4))
                const page = startPage + i
                if (page > totalPages) return null

                const isCurrentPage = page === currentPage
                return (
                  <a
                    href={page === 1 ? path : `${path}?page=${page}`}
                    class={`px-3 py-2 text-sm font-medium rounded-lg transition-colors duration-200 ${
                      isCurrentPage
                        ? 'bg-primary text-white'
                        : 'text-text bg-bg border border-border hover:bg-bg-offset'
                    }`}
                    aria-current={isCurrentPage ? 'page' : undefined}
                  >
                    {page}
                  </a>
                )
              })}

              {/* Show last page */}
              {currentPage < totalPages - 2 && (
                <>
                  {currentPage < totalPages - 3 && (
                    <span class="px-3 py-2 text-sm text-text-muted">…</span>
                  )}
                  <a
                    href={`${path}?page=${totalPages}`}
                    class="px-3 py-2 text-sm font-medium text-text bg-bg border border-border rounded-lg hover:bg-bg-offset transition-colors duration-200"
                  >
                    {totalPages}
                  </a>
                </>
              )}

              {currentPage < totalPages && (
                <a
                  href={`${path}?page=${currentPage + 1}`}
                  class="px-4 py-2 text-sm font-medium text-text bg-bg border border-border rounded-lg hover:bg-bg-offset transition-colors duration-200"
                >
                  Next →
                </a>
              )}
            </nav>
          )}
        </>
      ) : (
        <div class="text-center py-12">
          <p class="text-xl text-text-muted mb-4">
            No content found for this tag.
          </p>
          <a href="/tags/" class="text-primary hover:underline">
            Browse other tags
          </a>
        </div>
      )
    }
  </div>
</BaseLayout>
