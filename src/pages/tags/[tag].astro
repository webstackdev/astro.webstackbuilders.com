---
import { type CollectionEntry, getCollection, render } from 'astro:content'
import { Picture } from 'astro:assets'
import { isDev } from '@lib/config/environmentServer'
import BaseLayout from '@layouts/BaseLayout.astro'

export interface Params {
  tag: string
}

type ContentItem =
  | (CollectionEntry<'articles'> & { type: 'article' })
  | (CollectionEntry<'caseStudies'> & { type: 'case-study' })
  | (CollectionEntry<'services'> & { type: 'service' })
  | (CollectionEntry<'downloads'> & { type: 'download' })

export interface Props {
  content: ContentItem[]
}

export async function getStaticPaths() {
  const allTags = await getCollection('tags')

  // Get all content collections with tags
  const allArticles = await getCollection('articles', ({ data }) => {
    return isDev() || data.isDraft !== true
  })

  const allCaseStudies = await getCollection('caseStudies', ({ data }) => {
    return isDev() || data.isDraft !== true
  })
  const allServices = await getCollection('services', ({ data }) => {
    return isDev() || data.isDraft !== true
  })
  const allDownloads = await getCollection('downloads', ({ data }) => {
    return isDev() || data.isDraft !== true
  })

  // Combine all content and extract unique tags
  const allContent = [
    ...allArticles.map(item => ({ ...item, type: 'article' })),
    ...allCaseStudies.map(item => ({ ...item, type: 'case-study' })),
    ...allServices.map(item => ({ ...item, type: 'service' })),
    ...allDownloads.map(item => ({ ...item, type: 'download' })),
  ]

  const uniqueTags = [...new Set(allContent.map(item => item.data.tags).flat())]

  return allTags.map(tagEntry => {
    const tag = tagEntry.data.slug
    const filteredContent = uniqueTags.includes(tag)
      ? allContent.filter(item => item.data.tags.includes(tag))
      : []

    return {
      params: { tag },
      props: { content: filteredContent },
    }
  })
}

const { tag } = Astro.params
const { content: allTagContent } = Astro.props

const [tagEntry] = await getCollection('tags', ({ data }) => data.slug === tag)
if (!tagEntry) {
  throw new Error(`Unknown tag: ${tag}`)
}

const allTags = await getCollection('tags')
const tagDisplayNameBySlug = Object.fromEntries(allTags.map(t => [t.data.slug, t.data.displayName]))

const { Content: TagContent } = await render(tagEntry)

// Pagination setup
const ITEMS_PER_PAGE = 12
const currentPage = parseInt(Astro.url.searchParams.get('page') || '1')
const totalItems = allTagContent.length
const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE)
const startIndex = (currentPage - 1) * ITEMS_PER_PAGE
const endIndex = startIndex + ITEMS_PER_PAGE

// Sort by publish date (newest first) and paginate
const sortedContent = allTagContent.sort(
  (a, b) => new Date(b.data.publishDate).getTime() - new Date(a.data.publishDate).getTime()
)

const paginatedContent = sortedContent.slice(startIndex, endIndex)

const getTagDisplayName = (tagSlug: string) => {
  return tagDisplayNameBySlug[tagSlug] || tagSlug
}

const typeMetadata = {
  article: { label: 'Article', badgeClass: 'bg-primary', hrefBase: 'articles' },
  'case-study': { label: 'Case Study', badgeClass: 'bg-success', hrefBase: 'case-studies' },
  service: { label: 'Service', badgeClass: 'bg-accent', hrefBase: 'services' },
  download: { label: 'Download', badgeClass: 'bg-secondary', hrefBase: 'downloads' },
} as const

const displayName = tagEntry.data.displayName
const path = `/tags/${tag}`
const pageDescription = tagEntry.data.description
const pageTitle = `${displayName} - Tag`
const breadcrumbTitle = displayName
const section = 'Tags'
---

<BaseLayout
  pageTitle={pageTitle}
  path={path}
  description={pageDescription}
  breadcrumbTitle={breadcrumbTitle}
  section={section}
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <header class="mb-12">
      <div class="flex flex-col gap-6 sm:flex-row sm:items-start">
        <div class="shrink-0">
          <div
            class="relative w-28 sm:w-32 md:w-40 aspect-square overflow-hidden rounded-2xl bg-content-inverse-offset"
          >
            <img
              src={tagEntry.data.cover.src}
              width={tagEntry.data.cover.width}
              height={tagEntry.data.cover.height}
              alt={tagEntry.data.coverAlt}
              class="absolute inset-0 h-full w-full object-contain"
              loading="eager"
              decoding="async"
            />
          </div>
        </div>

        <div class="min-w-0 flex-1">
          <h1 class="text-4xl md:text-5xl font-bold text-content mb-4">
            {displayName}
          </h1>
          <p class="text-xl text-text-muted">
            {totalItems} item{totalItems !== 1 ? 's' : ''} tagged with {displayName.toLowerCase()}
          </p>
          <div class="mt-6 prose prose-invert max-w-none">
            <TagContent />
          </div>

          <nav class="mt-6">
            <a href="/tags" class="text-primary hover:underline"> ← Browse all tags </a>
          </nav>
        </div>
      </div>
    </header>

    {
      paginatedContent.length > 0 ? (
        <>
          <section
            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 lg:gap-12 mb-12"
            aria-labelledby="tagged-content-title"
          >
            <h2 class="sr-only" id="tagged-content-title">
              Tagged content
            </h2>
            {paginatedContent.map(item => {
              const typeMeta = typeMetadata[item.type]
              const href = `/${typeMeta.hrefBase}/${item.id}`

              return (
                <article class="bg-content-inverse rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 hover:-translate-y-1 overflow-hidden group">
                  {item.data.cover && (
                    <a href={href} class="block">
                      <div class="relative aspect-video overflow-hidden">
                        <Picture
                          src={item.data.cover}
                          alt={item.data.coverAlt}
                          widths={[320, 640, 960, 1280]}
                          sizes="(min-width: 1280px) 33vw, (min-width: 768px) 50vw, 100vw"
                          formats={['avif', 'webp', 'jpeg']}
                          layout="constrained"
                          fit="cover"
                          position="center"
                          class="absolute inset-0 h-full w-full object-cover group-hover:scale-105 transition-transform duration-300"
                          loading="lazy"
                        />
                      </div>
                    </a>
                  )}

                  <div class="p-6 space-y-4">
                    <div class="flex items-center gap-3 text-sm">
                      <span
                        class={`px-3 py-1 rounded-full text-white font-medium ${typeMeta.badgeClass}`}
                      >
                        {typeMeta.label}
                      </span>
                      <time class="text-text-muted" datetime={item.data.publishDate.toISOString()}>
                        {item.data.publishDate.toLocaleDateString('en-US', {
                          year: 'numeric',
                          month: 'long',
                          day: 'numeric',
                        })}
                      </time>
                    </div>

                    <h2 class="text-xl font-semibold text-content leading-tight">
                      <a
                        href={href}
                        class="group-hover:text-primary transition-colors duration-300"
                      >
                        {item.data.title}
                      </a>
                    </h2>

                    {item.data.description && (
                      <p class="text-text-muted text-sm leading-relaxed line-clamp-3">
                        {item.data.description}
                      </p>
                    )}

                    <div class="space-y-3 pt-2">
                      {/* Client or Author info */}
                      {'client' in item.data && item.data.client && (
                        <span class="inline-block text-sm font-medium text-primary bg-primary-bg px-3 py-1 rounded-full">
                          Client: {item.data.client}
                        </span>
                      )}

                      {/* Additional tags */}
                      {item.data.tags && item.data.tags.length > 1 && (
                        <ul
                          class="flex flex-wrap gap-2 list-none p-0 m-0"
                          aria-label="Related tags"
                        >
                          {item.data.tags
                            .filter((t: string) => t !== tag)
                            .slice(0, 3)
                            .map((relatedTag: string) => (
                              <li>
                                <a
                                  href={`/tags/${relatedTag}`}
                                  class="text-xs font-medium text-text-muted bg-content-inverse-offset hover:bg-gray-offset px-2 py-1 rounded-full transition-colors duration-200"
                                >
                                  {getTagDisplayName(relatedTag)}
                                </a>
                              </li>
                            ))}
                        </ul>
                      )}
                    </div>
                  </div>
                </article>
              )
            })}
          </section>

          {/* Pagination */}
          {totalPages > 1 && (
            <nav class="flex flex-wrap justify-center items-center gap-2" aria-label="Pagination">
              {currentPage > 1 && (
                <a
                  href={currentPage === 2 ? path : `${path}?page=${currentPage - 1}`}
                  class="px-4 py-2 text-sm font-medium text-content bg-content-inverse border border-border rounded-lg hover:bg-content-inverse-offset transition-colors duration-200"
                >
                  ← Previous
                </a>
              )}

              {/* Show first page */}
              {currentPage > 3 && (
                <>
                  <a
                    href={path}
                    class="px-3 py-2 text-sm font-medium text-content bg-content-inverse border border-border rounded-lg hover:bg-content-inverse-offset transition-colors duration-200"
                  >
                    1
                  </a>
                  {currentPage > 4 && <span class="px-3 py-2 text-sm text-text-muted">…</span>}
                </>
              )}

              {/* Show pages around current page */}
              {Array.from({ length: Math.min(5, totalPages) }, (_, i) => {
                const startPage = Math.max(1, Math.min(currentPage - 2, totalPages - 4))
                const page = startPage + i
                if (page > totalPages) return null

                const isCurrentPage = page === currentPage
                return (
                  <a
                    href={page === 1 ? path : `${path}?page=${page}`}
                    class={`px-3 py-2 text-sm font-medium rounded-lg transition-colors duration-200 ${
                      isCurrentPage
                        ? 'bg-spotlight text-white'
                        : 'text-content bg-content-inverse border border-border hover:bg-content-inverse-offset'
                    }`}
                    aria-current={isCurrentPage ? 'page' : undefined}
                  >
                    {page}
                  </a>
                )
              })}

              {/* Show last page */}
              {currentPage < totalPages - 2 && (
                <>
                  {currentPage < totalPages - 3 && (
                    <span class="px-3 py-2 text-sm text-text-muted">…</span>
                  )}
                  <a
                    href={`${path}?page=${totalPages}`}
                    class="px-3 py-2 text-sm font-medium text-content bg-content-inverse border border-border rounded-lg hover:bg-content-inverse-offset transition-colors duration-200"
                  >
                    {totalPages}
                  </a>
                </>
              )}

              {currentPage < totalPages && (
                <a
                  href={`${path}?page=${currentPage + 1}`}
                  class="px-4 py-2 text-sm font-medium text-content bg-content-inverse border border-border rounded-lg hover:bg-content-inverse-offset transition-colors duration-200"
                >
                  Next →
                </a>
              )}
            </nav>
          )}
        </>
      ) : (
        <div class="text-center py-12">
          <p class="text-xl text-text-muted mb-4">No content found for this tag.</p>
          <a href="/tags" class="text-primary hover:underline">
            Browse other tags
          </a>
        </div>
      )
    }
  </div>
</BaseLayout>
