---
import { type CollectionEntry, getCollection, render } from 'astro:content'
import { Picture } from 'astro:assets'
import { isDev } from '@lib/config/environmentServer'
import BaseLayout from '@layouts/BaseLayout.astro'

export interface Params {
  tag: string
}

export interface Props {
  content: Array<CollectionEntry<'articles'>>
}

export async function getStaticPaths() {
  const allTags = await getCollection('tags')
  const allArticles = await getCollection('articles', ({ data }) => isDev() || data.isDraft !== true)

  const articleHasTag = (article: CollectionEntry<'articles'>, tagEntry: CollectionEntry<'tags'>) => {
    return article.data.tags.some(tagRef => tagRef.id === tagEntry.id)
  }

  return allTags.map(tagEntry => {
    const tag = tagEntry.data.slug
    const filteredContent = allArticles.filter(article => articleHasTag(article, tagEntry))

    return {
      params: { tag },
      props: { content: filteredContent },
    }
  })
}

const { tag } = Astro.params
const { content: allTagContent } = Astro.props

const [tagEntry] = await getCollection('tags', ({ data }) => data.slug === tag)
if (!tagEntry) {
  throw new Error(`Unknown tag: ${tag}`)
}

const { Content: TagContent } = await render(tagEntry)

// Pagination setup
const ITEMS_PER_PAGE = 12
const currentPage = parseInt(Astro.url.searchParams.get('page') || '1')
const totalItems = allTagContent.length
const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE)
const startIndex = (currentPage - 1) * ITEMS_PER_PAGE
const endIndex = startIndex + ITEMS_PER_PAGE

// Sort by publish date (newest first) and paginate
const sortedContent = allTagContent.sort(
  (a, b) => new Date(b.data.publishDate).getTime() - new Date(a.data.publishDate).getTime()
)

const paginatedContent = sortedContent.slice(startIndex, endIndex)
---

<BaseLayout
  pageTitle={`${tagEntry.data.displayName} - Tag`}
  pageDescription={tagEntry.data.description}
  path={`/tags/${tag}`}
  breadcrumbTitle={tagEntry.data.displayName}
  section="Tags"
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <header class="mb-12">
      <div class="flex flex-col gap-6 sm:flex-row sm:items-start">
        <div class="shrink-0">
          <div
            class="relative w-28 sm:w-32 md:w-60 aspect-square overflow-hidden rounded-2xl bg-page-offset p-4"
          >
            <Picture
              src={tagEntry.data.cover}
              alt={tagEntry.data.coverAlt}
              widths={[112, 128, 240]}
              sizes="(min-width: 768px) 240px, (min-width: 640px) 128px, 112px"
              formats={['avif', 'webp', 'png']}
              layout="constrained"
              fit="contain"
              position="center"
              class="absolute inset-0 h-full w-full object-contain"
              loading="eager"
            />
          </div>
        </div>

        <div class="min-w-0 flex-1">
          <h1 class="text-4xl md:text-5xl font-bold mb-4">
            {tagEntry.data.displayName}
          </h1>
          <p class="text-xl">
            {totalItems} item{totalItems !== 1 ? 's' : ''} tagged with {tagEntry.data.displayName.toLowerCase()}
          </p>
          <nav class="mt-6">
            <a href="/tags" class="text-primary hover:underline"> ← Browse all tags </a>
          </nav>
        </div>
      </div>
    </header>

    <section class="prose prose-invert max-w-none mb-12" aria-label="Tag description">
      <TagContent />
    </section>

    {
      paginatedContent.length > 0 ? (
        <>
          <section
            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 lg:gap-12 mb-12"
            aria-labelledby="tagged-content-title"
          >
            <h2 class="sr-only" id="tagged-content-title">
              Tagged content
            </h2>
            {paginatedContent.map(item => {
              const href = `/articles/${item.id}`

              return (
                <article class="bg-content-inverse rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 hover:-translate-y-1 overflow-hidden group">
                  {item.data.cover && (
                    <a href={href} class="block">
                      <div class="relative aspect-video overflow-hidden">
                        <Picture
                          src={item.data.cover}
                          alt={item.data.coverAlt}
                          widths={[320, 640, 960, 1280]}
                          sizes="(min-width: 1280px) 33vw, (min-width: 768px) 50vw, 100vw"
                          formats={['avif', 'webp', 'jpeg']}
                          layout="constrained"
                          fit="cover"
                          position="center"
                          class="absolute inset-0 h-full w-full object-cover group-hover:scale-105 transition-transform duration-300"
                          loading="lazy"
                        />
                      </div>
                    </a>
                  )}

                  <div class="p-6 space-y-4">
                    <div class="flex items-center gap-3 text-sm">
                      <span
                        class="px-3 py-1 rounded-full text-white font-medium bg-primary"
                      >
                        Article
                      </span>
                      <time datetime={item.data.publishDate.toISOString()}>
                        {item.data.publishDate.toLocaleDateString('en-US', {
                          year: 'numeric',
                          month: 'long',
                          day: 'numeric',
                        })}
                      </time>
                    </div>

                    <h2 class="text-xl font-semibold leading-tight">
                      <a
                        href={href}
                        class="group-hover:text-primary transition-colors duration-300"
                      >
                        {item.data.title}
                      </a>
                    </h2>

                    {item.data.description && (
                      <p class="text-sm leading-relaxed line-clamp-3">
                        {item.data.description}
                      </p>
                    )}
                  </div>
                </article>
              )
            })}
          </section>

          {/* Pagination */}
          {totalPages > 1 && (
            <nav class="flex flex-wrap justify-center items-center gap-2" aria-label="Pagination">
              {currentPage > 1 && (
                <a
                  href={currentPage === 2 ? `/tags/${tag}` : `/tags/${tag}?page=${currentPage - 1}`}
                  class="px-4 py-2 text-sm font-medium bg-content-inverse border border-trim rounded-lg hover:bg-page-offset transition-colors duration-200"
                >
                  ← Previous
                </a>
              )}

              {/* Show first page */}
              {currentPage > 3 && (
                <>
                  <a
                    href={`/tags/${tag}`}
                    class="px-3 py-2 text-sm font-medium bg-content-inverse border border-trim rounded-lg hover:bg-page-offset transition-colors duration-200"
                  >
                    1
                  </a>
                  {currentPage > 4 && <span class="px-3 py-2 text-sm">…</span>}
                </>
              )}

              {/* Show pages around current page */}
              {Array.from({ length: Math.min(5, totalPages) }, (_, i) => {
                const startPage = Math.max(1, Math.min(currentPage - 2, totalPages - 4))
                const page = startPage + i
                if (page > totalPages) return null

                const isCurrentPage = page === currentPage
                return (
                  <a
                    href={page === 1 ? `/tags/${tag}` : `/tags/${tag}?page=${page}`}
                    class={`px-3 py-2 text-sm font-medium rounded-lg transition-colors duration-200 ${
                      isCurrentPage
                        ? 'bg-spotlight text-white'
                        : 'bg-content-inverse border border-trim hover:bg-page-offset'
                    }`}
                    aria-current={isCurrentPage ? 'page' : undefined}
                  >
                    {page}
                  </a>
                )
              })}

              {/* Show last page */}
              {currentPage < totalPages - 2 && (
                <>
                  {currentPage < totalPages - 3 && (
                    <span class="px-3 py-2 text-sm">…</span>
                  )}
                  <a
                    href={`/tags/${tag}?page=${totalPages}`}
                    class="px-3 py-2 text-sm font-medium bg-content-inverse border border-trim rounded-lg hover:bg-page-offset transition-colors duration-200"
                  >
                    {totalPages}
                  </a>
                </>
              )}

              {currentPage < totalPages && (
                <a
                  href={`/tags/${tag}?page=${currentPage + 1}`}
                  class="px-4 py-2 text-sm font-medium bg-content-inverse border border-trim rounded-lg hover:bg-page-offset transition-colors duration-200"
                >
                  Next →
                </a>
              )}
            </nav>
          )}
        </>
      ) : (
        <div class="text-center py-12">
          <p class="text-xl mb-4">No content found for this tag.</p>
          <a href="/tags" class="text-primary hover:underline">
            Browse other tags
          </a>
        </div>
      )
    }
  </div>
</BaseLayout>
