---
import { getCollection } from 'astro:content'
import { Picture } from 'astro:assets'
import { isDev, isProd } from '@lib/config/environmentServer'
import BaseLayout from '@layouts/BaseLayout.astro'

// Get all content collections with tags
const allArticles = await getCollection('articles', ({ data }) => {
  return isDev() || (isProd() && data.isDraft !== true)
})

const allCaseStudies = await getCollection('caseStudies', ({ data }) => {
  return isDev() || (isProd() && data.isDraft !== true)
})

const allServices = await getCollection('services', ({ data }) => {
  return isDev() || (isProd() && data.isDraft !== true)
})

// Combine all content and sort by publish date (newest first)
const allContent = [
  ...allArticles.map(item => ({ ...item, type: 'article' })),
  ...allCaseStudies.map(item => ({ ...item, type: 'case-study' })),
  ...allServices.map(item => ({ ...item, type: 'service' })),
].sort((a, b) => new Date(b.data.publishDate).getTime() - new Date(a.data.publishDate).getTime())

const allTags = await getCollection('tags')

// Function to get content preview for a specific tag
function getContentPreviewForTag(tag: string, limit: number = 4) {
  return allContent.filter(item => item.data.tags && item.data.tags.includes(tag)).slice(0, limit)
}

const tagsWithContent = allTags.filter(tag => {
  return getContentPreviewForTag(tag.data.slug, 1).length > 0
})

const tagsWithNoContent = allTags.filter(tag => getContentPreviewForTag(tag.data.slug, 1).length === 0)

for (const tag of tagsWithNoContent) {
  console.warn(
    `Warning: there were no content items for tag ${tag.data.displayName}. You might consider removing this tag if it is unused.`
  )
}

const pageDescription = 'Webstack Builders Services List'
const pageTitle = 'All Tags'
const path = '/tags'
const section = 'Tags'
---

<BaseLayout
  description={pageDescription}
  pageTitle={pageTitle}
  path={path}
  section={section}
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <header class="text-center mb-16">
      <h1 class="text-4xl md:text-5xl font-bold text-text mb-4">
        Browse by Tag
      </h1>
      <p class="text-xl text-text-muted max-w-3xl mx-auto">
        Explore our content organized by topics and technologies
      </p>
    </header>

    <div class="space-y-12">
      {
        tagsWithContent
          .sort((a, b) => a.data.displayName.localeCompare(b.data.displayName, 'en'))
          .map(tag => {
          const tagSlug = tag.data.slug
          const contentPreview = getContentPreviewForTag(tagSlug, 4)
          const displayName = tag.data.displayName
          const sectionTitleId = `tags-${tagSlug}-title`

          return (
            <section
              class="border-b border-border pb-12 last:border-b-0"
              aria-labelledby={sectionTitleId}
            >
              <header class="mb-6">
                <h2 class="text-2xl md:text-3xl font-bold text-text mb-2">
                  <a
                    href={`/tags/${tagSlug}`}
                    class="hover:text-primary transition-colors duration-300"
                    id={sectionTitleId}
                  >
                    {displayName}
                  </a>
                </h2>
                <p class="text-text-muted">
                  {contentPreview.length} item{contentPreview.length !== 1 ? 's' : ''}
                  {contentPreview.length >= 4 && (
                    <span class="ml-2">
                      <a
                        href={`/tags/${tagSlug}`}
                        class="text-primary hover:underline"
                      >
                        View all â†’
                      </a>
                    </span>
                  )}
                </p>
              </header>

              {/* Desktop: Show 3-4 cards in grid */}
              <div class="hidden md:grid md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                {contentPreview.map(item => {
                  const hrefBase =
                    item.type === 'case-study' ? 'case-studies' : item.type === 'service' ? 'services' : 'articles'
                  const href = `/${hrefBase}/${item.id}`

                  return (
                    <article class="bg-bg rounded-xl shadow-md hover:shadow-lg transition-all duration-300 hover:-translate-y-1 overflow-hidden group">
                      <a href={href} class="block h-full">
                        {item.data.cover && (
                          <div class="relative aspect-video overflow-hidden">
                            <Picture
                              src={item.data.cover}
                              alt={item.data.coverAlt}
                              widths={[320, 640, 960, 1280]}
                              sizes="(min-width: 1280px) 25vw, (min-width: 768px) 33vw, 100vw"
                              formats={['avif', 'webp', 'jpeg']}
                              layout="constrained"
                              fit="cover"
                              position="center"
                              class="absolute inset-0 h-full w-full object-cover group-hover:scale-105 transition-transform duration-300"
                              loading="lazy"
                            />
                          </div>
                        )}

                        <div class="p-4 space-y-3">
                          <div class="flex items-center gap-2 text-xs">
                            <span
                              class={`px-2 py-1 rounded-full text-white font-medium ${
                                item.type === 'article'
                                  ? 'bg-primary'
                                  : item.type === 'case-study'
                                    ? 'bg-success'
                                    : 'bg-accent'
                              }`}
                            >
                              {item.type === 'case-study'
                                ? 'Case Study'
                                : item.type.charAt(0).toUpperCase() + item.type.slice(1)}
                            </span>
                            <time
                              class="text-text-muted"
                              datetime={item.data.publishDate.toISOString()}
                            >
                              {item.data.publishDate.toLocaleDateString('en-US', {
                                month: 'short',
                                year: 'numeric',
                              })}
                            </time>
                          </div>

                          <h3 class="font-semibold text-text leading-tight group-hover:text-primary transition-colors duration-300 line-clamp-2">
                            {item.data.title}
                          </h3>

                          {item.data.description && (
                            <p class="text-sm text-text-muted line-clamp-2">
                              {item.data.description}
                            </p>
                          )}
                        </div>
                      </a>
                    </article>
                  )
                })}
              </div>

              {/* Mobile: Show single card */}
              <div class="md:hidden">
                {contentPreview.slice(0, 1).map(item => {
                  const hrefBase =
                    item.type === 'case-study' ? 'case-studies' : item.type === 'service' ? 'services' : 'articles'
                  const href = `/${hrefBase}/${item.id}`

                  return (
                    <article class="bg-bg rounded-xl shadow-md hover:shadow-lg transition-all duration-300 hover:-translate-y-1 overflow-hidden group">
                      <a href={href} class="block">
                        {item.data.cover && (
                          <div class="relative aspect-video overflow-hidden">
                            <Picture
                              src={item.data.cover}
                              alt={item.data.coverAlt}
                              widths={[640, 960, 1280]}
                              sizes="100vw"
                              formats={['avif', 'webp', 'jpeg']}
                              layout="constrained"
                              fit="cover"
                              position="center"
                              class="absolute inset-0 h-full w-full object-cover group-hover:scale-105 transition-transform duration-300"
                              loading="lazy"
                            />
                          </div>
                        )}

                        <div class="p-6 space-y-3">
                          <div class="flex items-center gap-2 text-sm">
                            <span
                              class={`px-3 py-1 rounded-full text-white font-medium ${
                                item.type === 'article'
                                  ? 'bg-primary'
                                  : item.type === 'case-study'
                                    ? 'bg-success'
                                    : 'bg-accent'
                              }`}
                            >
                              {item.type === 'case-study'
                                ? 'Case Study'
                                : item.type.charAt(0).toUpperCase() + item.type.slice(1)}
                            </span>
                            <time
                              class="text-text-muted"
                              datetime={item.data.publishDate.toISOString()}
                            >
                              {item.data.publishDate.toLocaleDateString('en-US', {
                                month: 'long',
                                year: 'numeric',
                              })}
                            </time>
                          </div>

                          <h3 class="text-lg font-semibold text-text leading-tight group-hover:text-primary transition-colors duration-300">
                            {item.data.title}
                          </h3>

                          {item.data.description && (
                            <p class="text-text-muted line-clamp-3">
                              {item.data.description}
                            </p>
                          )}

                          <div class="pt-2">
                            <span class="inline-flex items-center text-primary font-medium text-sm">
                              View{' '}
                              {contentPreview.length > 1
                                ? `all ${contentPreview.length} items`
                                : 'details'}
                              <svg
                                class="w-4 h-4 ml-1"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                                aria-hidden="true"
                                focusable="false"
                              >
                                <path
                                  stroke-linecap="round"
                                  stroke-linejoin="round"
                                  stroke-width="2"
                                  d="M9 5l7 7-7 7"
                                />
                              </svg>
                            </span>
                          </div>
                        </div>
                      </a>
                    </article>
                  )
                })}
              </div>
            </section>
          )
        })
      }
    </div>
  </div>
</BaseLayout>
