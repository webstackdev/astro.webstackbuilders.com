---
import { type CollectionEntry, getCollection } from 'astro:content'
import { isDev } from '@lib/config/environmentServer'
import BaseLayout from '@layouts/BaseLayout.astro'

import Carousel from '@components/Carousel/index.astro'

const allArticles = await getCollection('articles', ({ data }) => isDev() || data.isDraft !== true)

const allTags = await getCollection('tags')

const getArticlesForTag = (tagEntry: CollectionEntry<'tags'>) => {
  return allArticles.filter(article => {
    return article.data.tags.some(tagRef => tagRef.id === tagEntry.id)
  })
}

const tagsWithContent = allTags.filter(tag => getArticlesForTag(tag).length > 0)

const tagsWithNoContent = allTags.filter(tag => getArticlesForTag(tag).length === 0)

for (const tag of tagsWithNoContent) {
  console.warn(
    `Warning: there were no content items for tag ${tag.data.displayName}. You might consider removing this tag if it is unused.`
  )
}

const pageDescription = 'Browse all article tags'
const pageTitle = 'All Tags'
const path = '/tags'
const section = 'Tags'
---

<BaseLayout description={pageDescription} pageTitle={pageTitle} path={path} section={section}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <header class="text-center mb-16">
      <h1 class="text-4xl md:text-5xl font-bold mb-4">Technical Index</h1>
      <p class="text-xl max-w-3xl mx-auto">
        Browse documentation and guides structured by specific topics like Kubernetes, developer experience, and release engineering
      </p>
    </header>

    <div class="space-y-12">
      {
        tagsWithContent
          .sort((a, b) => a.data.displayName.localeCompare(b.data.displayName, 'en'))
          .map(tag => {
            const tagSlug = tag.data.slug
            const displayName = tag.data.displayName
            const articlesForTag = getArticlesForTag(tag)

            return (
              <section class="border-b border-trim pb-12 last:border-b-0">
                <Carousel
                  title={displayName}
                  titleHref={`/tags/${tagSlug}`}
                  variant="suggested"
                  limit={articlesForTag.length}
                  type="articles"
                  items={articlesForTag}
                />
              </section>
            )
          })
      }
    </div>
  </div>
</BaseLayout>
