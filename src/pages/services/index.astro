---
import { getCollection } from 'astro:content'
import PageLayout from '@layouts/PageLayout.astro'

/** Get all services from content collection */
const allServices = await getCollection('services')

/** Filter and sort services */
const services = allServices
  .filter(service => !service.data.isDraft)
  .sort((a, b) => a.data.order - b.data.order)

const splitH2Sections = (html: string): string[] => {
  if (!html.trim()) {
    return []
  }

  return html
    .split(/(?=<h2\b)/g)
    .map(section => section.trim())
    .filter(Boolean)
}


const pageDescription = 'Webstack Builders Services List'
const pageTitle = 'Our Services'
const path = '/services/'
const section = 'Services'
---

<PageLayout
  description={pageDescription}
  pageTitle={pageTitle}
  path={path}
  section={section}
  subtitle="Professional web development and consulting services"
>
  {
    services.length > 0 && (
      <section
        class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12"
        aria-labelledby="services-list-title"
      >
        <header class="text-center mb-12">
          <h2 class="text-3xl md:text-4xl font-bold" id="services-list-title">
            Our Services
          </h2>
        </header>
        <div class="grid gap-6">
          {services.map(service => {
            const sections = splitH2Sections(service.rendered?.html ?? '')
            const leftSections = sections.slice(0, 2).join('')
            const rightSections = sections.slice(2, 4).join('')

            return (
              <article class="h-full rounded-lg border border-trim p-6">
                <h3 class="text-xl md:text-2xl font-semibold mb-3">
                  {service.data.title}
                </h3>
                <div class="mt-4 grid gap-6 md:grid-cols-2">
                  <div class="space-y-6">
                    <Fragment set:html={leftSections} />
                  </div>
                  <div class="space-y-6">
                    <Fragment set:html={rightSections} />
                  </div>
                </div>
              </article>
            )
          })}
        </div>
      </section>
    )
  }
</PageLayout>
