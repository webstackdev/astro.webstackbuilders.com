---
import { getCollection } from 'astro:content'
import PageLayout from '@layouts/PageLayout.astro'

/** Get all services from content collection */
const allServices = await getCollection('services')

/** Filter and sort services */
const services = allServices
  .filter(service => !service.data.isDraft)
  .sort((a, b) => a.data.order - b.data.order)

/**
 * Splits rendered markdown at each `<h2>` boundary so we can place the
 * "What You Get" + "Good Fit For" sections on the left and the
 * "How It Works" + "Pricing" sections on the right.
 */
const splitH2Sections = (html: string): string[] => {
  if (!html.trim()) {
    return []
  }

  return html
    .split(/(?=<h2\b)/g)
    .map(section => section.trim())
    .filter(Boolean)
}

const pageTitle = 'Our Services'
const pageDescription = 'Flexible options from full-time capacity to one-off assessments — all month-to-month with no long-term lock-in.'
const path = '/services/'
---

<PageLayout
  pageTitle={pageTitle}
  pageDescription={pageDescription}
  icon="wrench"
  path={path}
>
  <section class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    {services.length > 0 && (
      <div class="grid gap-8 md:grid-cols-2">
        {services.map((service, i) => {
          const sections = splitH2Sections(service.rendered?.html ?? '')
          const leftSections = sections.slice(0, 2).join('')
          const rightSections = sections.slice(2, 4).join('')

          return (
            <article
              class:list={[
                'flex flex-col rounded-2xl border overflow-hidden transition-shadow hover:shadow-lg',
                i === 0 ? 'border-spotlight shadow-md ring-2 ring-spotlight/30' : 'border-trim',
              ]}
            >
              {/* Colored header */}
              <div
                class:list={[
                  'px-6 py-5',
                  i === 0
                    ? 'bg-primary text-primary-inverse'
                    : 'bg-page-offset text-page-inverse',
                ]}
              >
                {i === 0 && (
                  <span class="mb-2 inline-block rounded-full bg-spotlight px-3 py-0.5 text-xs font-bold uppercase tracking-wider text-primary">
                    Most Popular
                  </span>
                )}
                <h3 class="text-xl font-bold">{service.data.title}</h3>
                <p
                  class:list={[
                    'mt-2 text-sm leading-relaxed',
                    i === 0 ? 'text-primary-inverse/70' : 'text-content-offset',
                  ]}
                >
                  {service.data.description}
                </p>
              </div>

              {/* Body — two-column content from rendered markdown */}
              <div class="flex flex-1 flex-col bg-content-inverse px-6 py-6">
                <div class="grid gap-6 md:grid-cols-2">
                  <div class="space-y-6 [&_h2]:text-sm [&_h2]:font-semibold [&_h2]:uppercase [&_h2]:tracking-wider [&_h2]:text-page-inverse [&_h2]:mb-2 [&_h2]:mt-0 [&_p]:text-content [&_p]:text-sm [&_p]:leading-relaxed [&_ul]:space-y-1.5 [&_ul]:text-sm [&_ul]:text-content [&_ul]:list-none [&_ul]:pl-0 [&_li]:flex [&_li]:items-start [&_li]:gap-2 [&_li]:before:content-['✓'] [&_li]:before:text-success [&_li]:before:mt-0.5 [&_li]:before:shrink-0">
                    <Fragment set:html={leftSections} />
                  </div>
                  <div class="space-y-6 [&_h2]:text-sm [&_h2]:font-semibold [&_h2]:uppercase [&_h2]:tracking-wider [&_h2]:text-page-inverse [&_h2]:mb-2 [&_h2]:mt-0 [&_p]:text-content [&_p]:text-sm [&_p]:leading-relaxed [&_strong]:text-page-inverse">
                    <Fragment set:html={rightSections} />
                  </div>
                </div>
              </div>
            </article>
          )
        })}
      </div>
    )}
  </section>
</PageLayout>
