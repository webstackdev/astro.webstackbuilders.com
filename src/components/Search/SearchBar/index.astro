---
import Icon from '@components/Icon/index.astro'
import closeSvg from '../../../icons/close.svg?raw'
import microphoneSvg from '../../../icons/microphone.svg?raw'
import styles from './index.module.css'

export interface Props {
  placeholder?: string
  initialQuery?: string
  variant?: 'page' | 'header'
  initialExpanded?: boolean
}

const {
  placeholder = 'Searchâ€¦',
  initialQuery = '',
  variant = 'page',
  initialExpanded = false,
} = Astro.props

const isHeaderVariant = variant === 'header'
const isExpandedOnLoad = isHeaderVariant ? initialExpanded || initialQuery.trim().length > 0 : true
const hasInitialQuery = initialQuery.trim().length > 0
const clearButtonLabel = hasInitialQuery ? 'Clear search' : 'Close search'
---

<search-bar
  class:list={['relative block', styles.searchBar]}
  data-testid="search-bar"
  data-search-variant={variant}
>
  {
    isHeaderVariant ? (
      <div
        data-search-panel
        data-state={isExpandedOnLoad ? 'open' : 'closed'}
        class="relative z-(--z-content-overlay) w-(--header-icon-size) h-(--header-icon-size) data-[state=open]:absolute data-[state=open]:top-0 data-[state=open]:right-(--header-search-panel-right) data-[state=open]:w-(--header-search-panel-width-open) data-[state=open]:z-(--z-modal)"
      >
        <form
          data-search-form
          data-state={isExpandedOnLoad ? 'open' : 'closed'}
          class="flex items-center w-full h-(--header-icon-size) overflow-visible rounded-full data-[state=open]:bg-page-base data-[state=open]:shadow-elevated"
          role="search"
          aria-label="Site search"
        >
          <input
            data-search-input
            type="search"
            inputmode="search"
            autocomplete="off"
            aria-label="Search"
            placeholder={placeholder}
            value={initialQuery}
            class:list={[
              'min-w-0 flex-1 h-(--header-icon-size) bg-transparent px-4 text-base placeholder:text-content-active border-0 focus:outline-none focus-visible:outline-none focus:ring-0 focus-visible:ring-0 focus:ring-offset-0 focus-visible:ring-offset-0',
              !isExpandedOnLoad && 'hidden',
            ]}
          />

          <button
            data-search-mic
            type="button"
            aria-label="Voice search"
            hidden
            class="relative inline-flex items-center justify-center w-(--header-icon-size) h-(--header-icon-size) shrink-0 rounded-full border-0 bg-transparent text-content-active hover:text-primary focus-visible:text-primary focus-visible:outline-none after:pointer-events-none after:absolute after:content-[''] after:inset-0 after:rounded-none after:border-2 after:border-transparent after:opacity-0 after:transition-opacity after:duration-150 after:ease-out focus-visible:after:opacity-100 focus-visible:after:-inset-1.5 focus-visible:after:border-spotlight transition-colors duration-150 ease-linear"
          >
            <span aria-hidden="true" set:html={microphoneSvg} />
          </button>

          <button
            data-search-clear
            type="button"
            aria-label={clearButtonLabel}
            hidden={!isExpandedOnLoad}
            class="relative inline-flex items-center justify-center w-(--header-icon-size) h-(--header-icon-size) shrink-0 rounded-full border-0 bg-transparent text-content-active hover:text-primary focus-visible:text-primary focus-visible:outline-none after:pointer-events-none after:absolute after:content-[''] after:inset-0 after:rounded-none after:border-2 after:border-transparent after:opacity-0 after:transition-opacity after:duration-150 after:ease-out focus-visible:after:opacity-100 focus-visible:after:-inset-1.5 focus-visible:after:border-spotlight transition-colors duration-150 ease-linear"
          >
            <span aria-hidden="true" set:html={closeSvg} />
          </button>

          <button
            data-search-toggle
            type="button"
            aria-label="Search"
            aria-expanded={isExpandedOnLoad ? 'true' : 'false'}
            data-state={isExpandedOnLoad ? 'open' : 'closed'}
            hidden={isExpandedOnLoad}
            class="relative inline-flex items-center justify-center w-(--header-icon-size) h-(--header-icon-size) shrink-0 rounded-full border-0 bg-primary hover:bg-primary-offset focus:bg-primary-offset focus-visible:bg-primary-offset focus-visible:outline-none after:pointer-events-none after:absolute after:content-[''] after:inset-0 after:rounded-none after:border-2 after:border-transparent after:opacity-0 after:transition-opacity after:duration-150 after:ease-out focus-visible:after:opacity-100 focus-visible:after:-inset-1.5 focus-visible:after:border-spotlight transition-colors duration-150 ease-linear data-[state=open]:bg-transparent data-[state=open]:hover:bg-transparent data-[state=open]:focus:bg-transparent data-[state=open]:focus-visible:bg-transparent"
          >
            <Icon
              name="search"
              variant="custom"
              class="fill-page-base text-page-base w-(--header-icon-svg-size) h-(--header-icon-svg-size)"
            />
          </button>
        </form>

        <div
          data-search-results
          class="absolute left-0 right-0 z-(--z-content-floating) mt-2 hidden overflow-hidden rounded-lg border border-trim bg-(--color-gray-300) shadow-elevated"
        >
          <ul data-search-results-list class="divide-y divide-border" aria-label="Search suggestions"></ul>
        </div>
      </div>
    ) : (
      <>
        <form data-search-form class="relative" role="search" aria-label="Site search">
          <input
            data-search-input
            type="search"
            inputmode="search"
            autocomplete="off"
            aria-label="Search"
            placeholder={placeholder}
            value={initialQuery}
            class="w-full rounded-lg border border-trim bg-page-base px-4 py-3 placeholder:text-content-active focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary"
          />
        </form>

        <div
          data-search-results
          class="absolute left-0 right-0 z-(--z-content-floating) mt-2 hidden overflow-hidden rounded-lg border border-trim bg-(--color-gray-300) shadow-elevated"
        >
          <ul data-search-results-list class="divide-y divide-border" aria-label="Search suggestions"></ul>
        </div>
      </>
    )
  }

  <script>
    import { registerSearchBarComponent } from '@components/Search/SearchBar/client'
    registerSearchBarComponent()
  </script>
</search-bar>
