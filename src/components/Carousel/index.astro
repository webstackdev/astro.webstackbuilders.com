---
/**
 * Generic Carousel component for displaying content - both featured and suggested
 */
import { Picture } from 'astro:assets'
import { getCollection } from 'astro:content'
import Icon from '@components/Icon/index.astro'
import {
  type CarouselNavigationMode,
  type CarouselVariant,
  type ItemType,
  type KnownCollectionSlug,
  collectionMap,
} from './@types'
import { prepareItems } from './server'

type BaseProps = {
  title?: string
  /** A link to apply to the carousel title */
  titleHref?: string
  /** Return first 'limit' number of items from the filtered collection */
  limit?: number
  /** Variant controls what items to filter based on featured, latest, random */
  variant?: CarouselVariant
  /** Used to filter out current item from collection used in carousel */
  currentSlug?: string
  /** Controls whether navigation wraps around */
  navigationMode?: CarouselNavigationMode
  /** Whether to show the "Read More" link */
  showReadMore: boolean
}

export type Props =
  | (BaseProps & {
      /** Type of collection: articles, case-studies, or services */
      type: KnownCollectionSlug
      /** Caller can pass items in or let the component fetch them */
      items?: ItemType[]
    })
  | (BaseProps & {
      /** Unknown type requires explicit items */
      type: 'unknown'
      items: ItemType[]
    })

const props: Props = Astro.props

const {
  title,
  titleHref,
  limit = 3,
  variant = 'featured',
  currentSlug,
  type,
  items: itemsOverride,
  navigationMode = 'wrap',
  showReadMore = false,
} = props

const isKnownCollectionSlug = (slug: Props['type']): slug is KnownCollectionSlug => slug !== 'unknown'

const allItems: ItemType[] = itemsOverride
  ? itemsOverride
  : !isKnownCollectionSlug(type)
    ? (() => {
        throw new Error('Carousel: type="unknown" requires `items` to be provided')
      })()
    : await getCollection(collectionMap[type])

const items = prepareItems(allItems, variant, currentSlug, limit)

const carouselId = `carousel-${type}-${variant}-${currentSlug ?? 'all'}`
---

{
  items.length > 0 && (
    <carousel-slider
      data-carousel
      data-carousel-navigation-mode={navigationMode}
      class="block"
    >
      <section class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {title && (
          <header class="text-center mb-6">
            <h2 id={`${carouselId}-title`} class="font-bold">
              {titleHref ? (
                <a href={titleHref} class="hover:text-primary transition-colors duration-200 no-underline">
                  {title}
                </a>
              ) : (
                title
              )}
            </h2>
          </header>
        )}

        {/* Embla Carousel */}
        <div class="embla relative" role="region" aria-labelledby={`${carouselId}-title`}>
          <div class="embla__viewport overflow-hidden p-4">
            <div class="embla__container flex -ml-4 md:-ml-6">
              {items.map((item: ItemType, index) => (
                <div
                  class="embla__slide pl-4 md:pl-6 flex-[0_0_100%] md:flex-[0_0_50%] lg:flex-[0_0_33.333%] min-w-0"
                  data-carousel-slide
                  data-index={String(index)}
                >
                  <article class="group h-full relative after:pointer-events-none after:absolute after:content-[''] after:inset-0 after:rounded-none after:border-2 after:border-transparent after:opacity-0 after:transition-opacity after:duration-150 after:ease-out focus-within:after:opacity-100 focus-within:after:-inset-1.5 focus-within:after:border-spotlight">
                    <a
                      href={'href' in item ? item.href : `/${type}/${item.id}`}
                      class="block h-full bg-content-inverse rounded-xl shadow-lg transition-all duration-300 overflow-hidden border border-trim transform hover:-translate-y-2 no-underline hover:no-underline focus-visible:no-underline focus-visible:outline-none focus-visible:shadow-none"
                    >
                      {item.data.cover && (
                        <div class="relative aspect-video overflow-hidden">
                          <Picture
                            src={item.data.cover}
                            alt={item.data.coverAlt}
                            widths={[320, 640, 960, 1280]}
                            sizes="(min-width: 1024px) 33vw, (min-width: 768px) 50vw, 100vw"
                            formats={['avif', 'webp', 'jpeg']}
                            layout="constrained"
                            fit="cover"
                            position="center"
                            class="absolute inset-0 h-full w-full"
                          />
                        </div>
                      )}
                      <div class="p-6 pt-2">
                        <h3 class="text-xl font-semibold mb-3 group-hover:text-primary transition-colors">
                          {item.data.title}
                        </h3>
                        {item.data.description && (
                          <p class="text-content-offset leading-relaxed text-sm">{item.data.description}</p>
                        )}
                        <div class="mt-4 flex items-center text-primary text-sm font-medium opacity-0 group-hover:opacity-100 transition-opacity">
                          <span>Learn more</span>
                          <svg
                            class="ml-1 w-4 h-4 transform group-hover:translate-x-1 transition-transform"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                            aria-hidden="true"
                            focusable="false"
                          >
                            <path
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              stroke-width="2"
                              d="M17 8l4 4m0 0l-4 4m4-4H3"
                            />
                          </svg>
                        </div>
                      </div>
                    </a>
                  </article>
                </div>
              ))}
            </div>
          </div>

          {/* Navigation Buttons */}
          <button
            type="button"
            class:list={[
              "embla__button embla__button--prev",
              "absolute w-12 h-12 left-0 top-1/2 -translate-y-1/2 -translate-x-4",
              "bg-content-inverse",
              "rounded-full border-2 border-trim shadow-lg",
              "hover:bg-content-inverse-active hover:border-gray-200",
              "transition-all duration-300 flex items-center justify-center z-(--z-raised)",
              "disabled:opacity-30 disabled:cursor-not-allowed",
              "focus-visible:outline-none focus-visible:after:border-2 focus-visible:after:border-spotlight",
              "after:pointer-events-none after:absolute after:-inset-0.5 after:rounded-none after:content-['']"
            ]}
            aria-label="Previous slide"
            data-carousel-prev
          >
            <Icon icon="arrow-left" size={6} color="currentColor" />
          </button>

          <button
            type="button"
            class:list={[
              "embla__button embla__button--next",
              "absolute w-12 h-12 right-0 top-1/2 -translate-y-1/2 translate-x-4",
              "bg-content-inverse",
              "rounded-full border-2 border-trim shadow-lg",
              "hover:bg-content-inverse-active hover:border-gray-200",
              "transition-all duration-300 flex items-center justify-center z-(--z-raised)",
              "disabled:opacity-30 disabled:cursor-not-allowed",
              "focus-visible:outline-none focus-visible:after:border-2 focus-visible:after:border-spotlight",
              "after:pointer-events-none after:absolute after:-inset-0.5 after:rounded-none after:content-['']"
            ]}
            aria-label="Next slide"
            data-carousel-next
          >
            <Icon icon="arrow-right" size={6} color="currentColor" />
          </button>

          {/* Dots Navigation */}
          <div class="mt-8 grid grid-cols-[1fr_auto_1fr] items-center">
            <span aria-hidden="true" />
            <span
              class="embla__dots flex gap-2 justify-center"
              role="group"
              aria-label={`${title} slide navigation`}
              data-carousel-pagination
            />

            {showReadMore ? (
              <span class="flex justify-end mr-4">
                <a
                  href="/articles"
                  class="relative inline-flex items-center px-6 py-3 bg-content-active text-content-inverse font-semibold rounded-lg hover:bg-content no-underline hover:no-underline transition-all duration-200 focus-visible:outline-none after:pointer-events-none after:absolute after:content-[''] after:inset-0 after:rounded-none after:border-2 after:border-transparent focus-visible:after:-inset-0.5 focus-visible:after:border-spotlight"
                >
                  Read More Articles
                  <svg
                    class="ml-2 w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                    aria-hidden="true"
                    focusable="false"
                  >
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"
                    ></path>
                  </svg>
                </a>
              </span>
            ) : (
              <span aria-hidden="true" />
            )}
          </div>

          <p
            class="sr-only"
            role="status"
            aria-live="polite"
            aria-atomic="true"
            data-carousel-status
          />
        </div>
      </section>
    </carousel-slider>
  )
}

<script>
  import { registerCarouselWebComponent } from '@components/Carousel/client'
  registerCarouselWebComponent()
</script>
