---
/**
 * Generic Carousel component for displaying content - both featured and suggested
 */
import { Picture } from 'astro:assets'
import { getCollection } from 'astro:content'

import { type CollectionSlug, type CarouselVariant, type ItemType, collectionMap } from './@types'
import { prepareItems } from './server'

export interface Props {
  title?: string
  titleHref?: string
  limit?: number
  variant?: CarouselVariant
  currentSlug: string
  type: CollectionSlug
  items?: ItemType[]
}

const {
  title = 'Featured Content',
  titleHref,
  limit = 3,
  variant = 'featured',
  currentSlug,
  type,
  items: itemsOverride,
} = Astro.props

const allItems = itemsOverride ?? (await getCollection(collectionMap[type]))
const items = prepareItems(allItems, variant, currentSlug, limit)

const carouselId = `carousel-${type}-${variant}-${currentSlug}`
---

{
  items.length > 0 && (
    <carousel-slider data-carousel class="block">
      <section class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
        <header class="text-center mb-12">
          <h2 id={`${carouselId}-title`} class="text-3xl md:text-4xl font-bold">
            {titleHref ? (
              <a href={titleHref} class="hover:text-primary transition-colors duration-200">
                {title}
              </a>
            ) : (
              title
            )}
          </h2>
        </header>

        {/* Embla Carousel */}
        <div class="embla relative" role="region" aria-labelledby={`${carouselId}-title`}>
          <div class="embla__viewport overflow-hidden">
            <div class="embla__container flex gap-4 md:gap-6">
              {items.map((item: ItemType, index) => (
                <div
                  class="embla__slide flex-[0_0_100%] md:flex-[0_0_50%] lg:flex-[0_0_33.333%] min-w-0"
                  data-carousel-slide
                  data-index={String(index)}
                >
                  <article class="group h-full">
                    <a
                      href={`/${type}/${item.id}`}
                      class="block h-full bg-content-inverse rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 overflow-hidden border border-trim hover:border-primary transform hover:-translate-y-2"
                    >
                      {item.data.cover && (
                        <div class="relative aspect-video overflow-hidden">
                          <Picture
                            src={item.data.cover}
                            alt={item.data.coverAlt}
                            widths={[320, 640, 960, 1280]}
                            sizes="(min-width: 1024px) 33vw, (min-width: 768px) 50vw, 100vw"
                            formats={['avif', 'webp', 'jpeg']}
                            layout="constrained"
                            fit="cover"
                            position="center"
                            class="absolute inset-0 h-full w-full"
                          />
                        </div>
                      )}
                      <div class="p-6 pt-2">
                        <h3 class="text-xl font-semibold mb-3 group-hover:text-primary transition-colors">
                          {item.data.title}
                        </h3>
                        {item.data.description && (
                          <p class="text-content-offset leading-relaxed text-sm">{item.data.description}</p>
                        )}
                        <div class="mt-4 flex items-center text-primary text-sm font-medium opacity-0 group-hover:opacity-100 transition-opacity">
                          <span>Learn more</span>
                          <svg
                            class="ml-1 w-4 h-4 transform group-hover:translate-x-1 transition-transform"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                            aria-hidden="true"
                            focusable="false"
                          >
                            <path
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              stroke-width="2"
                              d="M17 8l4 4m0 0l-4 4m4-4H3"
                            />
                          </svg>
                        </div>
                      </div>
                    </a>
                  </article>
                </div>
              ))}
            </div>
          </div>

          {/* Navigation Buttons */}
          <button
            type="button"
            class="embla__button embla__button--prev absolute left-0 top-1/2 -translate-y-1/2 -translate-x-4 w-12 h-12 rounded-full bg-content-inverse border-2 border-trim shadow-lg hover:bg-spotlight hover:border-primary transition-all duration-300 flex items-center justify-center z-(--z-raised) disabled:opacity-30 disabled:cursor-not-allowed"
            aria-label="Previous slide"
            data-carousel-prev
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              aria-hidden="true"
              focusable="false"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 19l-7-7 7-7"
              />
            </svg>
          </button>

          <button
            type="button"
            class="embla__button embla__button--next absolute right-0 top-1/2 -translate-y-1/2 translate-x-4 w-12 h-12 rounded-full bg-content-inverse border-2 border-trim shadow-lg hover:bg-spotlight hover:border-primary transition-all duration-300 flex items-center justify-center z-(--z-raised) disabled:opacity-30 disabled:cursor-not-allowed"
            aria-label="Next slide"
            data-carousel-next
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              aria-hidden="true"
              focusable="false"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 5l7 7-7 7"
              />
            </svg>
          </button>

          {/* Dots Navigation */}
          <div
            class="embla__dots flex gap-2 justify-center mt-8"
            role="group"
            aria-label={`${title} slide navigation`}
            data-carousel-pagination
          />

          <p
            class="sr-only"
            role="status"
            aria-live="polite"
            aria-atomic="true"
            data-carousel-status
          />
        </div>
      </section>
    </carousel-slider>
  )
}

<script>
  import { registerCarouselWebComponent } from '@components/Carousel/client'
  registerCarouselWebComponent()
</script>
