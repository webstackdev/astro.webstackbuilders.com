---
import { Picture } from 'astro:assets'
import { type CollectionEntry, render } from 'astro:content'
import Confetti from '@components/Animations/Confetti/index.astro'
import GDPRConsent from '@components/Consent/Checkbox/index.astro'
import Icon from '@components/Icon/index.astro'
import List from '@components/List/index.astro'

import './index.css'

const Components = { List }

export interface Props {
  download: CollectionEntry<'downloads'>
}

const { download } = Astro.props as Props

const {
  cover,
  coverAlt,
  fileName,
  fileType,
  fileSize,
  pages,
  title,
} = download.data

const { Content } = await render(download)

const normalizedDownloadUrl = `/downloads/${fileName}`
---

<download-form class="mb-8 md:mb-30">
  {/* Two-column layout on desktop: info left, form right */}
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-2 md:gap-10 lg:gap-12 items-start">
    {/* Left column: cover, meta, content */}
    <div class="lg:col-span-2">
      <div class="flex flex-col md:flex-row items-start gap-6mb-8">
        {
          cover && (
            <section
              class="relative aspect-square w-60 md:w-80 max-w-full mx-auto md:mx-0 rounded-2xl overflow-hidden shrink-0"
              aria-label="Cover image"
            >
              <Picture
                src={cover}
                alt={coverAlt}
                widths={[320, 480, 640]}
                sizes="(min-width: 768px) 320px, 100vw"
                formats={['avif', 'webp', 'jpeg']}
                layout="constrained"
                fit="cover"
                position="center"
                class="absolute inset-0 h-full w-full object-cover"
                loading="eager"
              />
            </section>
          )
        }

        {/* Resource Meta Information */}
        <section
          class="w-full px-6 md:px-0 md:mx-6 mt-6 md:mt-1"
          aria-label="Resource details"
        >
          <p class="text-lg text-page-inverse leading-relaxed mt-1 mb-6 p-6 bg-page-offset rounded-xl border border-trim">
            {download.data.description}
          </p>

          <dl class="flex items-center justify-center gap-6">
            <div class="flex items-center gap-2">
              <Icon icon="document" size={6} color="page-inverse" />
              <dt class="sr-only">File type</dt>
              <dd class="text-sm font-medium text-page-inverse">{fileType}</dd>
            </div>
            {
              pages && (
                <div class="flex items-center gap-2">
                  <Icon icon="book" size={6} color="page-inverse" />
                  <dt class="sr-only">Pages</dt>
                  <dd class="text-sm text-page-inverse">{pages} pages</dd>
                </div>
              )
            }
            {
              fileSize && (
                <div class="flex items-center gap-2">
                  <Icon icon="file" size={6} color="page-inverse" />
                  <dt class="sr-only">File size</dt>
                  <dd class="text-sm text-page-inverse">{fileSize}</dd>
                </div>
              )
            }
          </dl>
        </section>
      </div>

      <section
        class="md:mt-4 md:mb-8 pt-4 md:p-4"
        aria-label="Resource details"
      >
        <Content components={{ ...Components }} />
      </section>
    </div>{/* end left column */}

    {/* Right column: download form */}
    <div class="lg:col-span-1 lg:sticky lg:top-24">
      <div class="bg-(--color-blue-600) p-6 md:p-8 rounded-2xl border border-(--color-blue-800)">
        <div class="mb-6">
          <h3 class="text-xl md:text-2xl font-semibold mb-2 text-white">{title}</h3>
          <p class="text-(--color-blue-100)">
            Fill out the form below to receive your {fileType.toLowerCase()} instantly.
          </p>
        </div>

        <form
          class="space-y-4"
          id="downloadForm"
          method="post"
          data-download-url={normalizedDownloadUrl}
        >
          <div class="space-y-4">
            {/* First Name */}
            <div class="space-y-2">
              <label for="firstName" class="block text-(--color-blue-100) text-sm font-medium">
                First Name <span class="text-(--color-blue-200)">*</span>
              </label>
              <input
                type="text"
                id="firstName"
                name="firstName"
                autocomplete="given-name"
                class="w-full px-4 py-3 border border-(--color-blue-400) rounded-xl bg-blue-800/40 text-white placeholder:text-(--color-blue-300) focus:border-(--color-blue-200) focus:ring-0 focus:outline-none focus-visible:outline-2 focus-visible:outline-white focus-visible:outline-offset-2 focus-visible:rounded-none transition-colors duration-200"
                required
                placeholder="John"
                minlength="2"
                maxlength="50"
              />
            </div>

            {/* Last Name */}
            <div class="space-y-2">
              <label for="lastName" class="block text-(--color-blue-100) text-sm font-medium">
                Last Name <span class="text-(--color-blue-200)">*</span>
              </label>
              <input
                type="text"
                id="lastName"
                name="lastName"
                autocomplete="family-name"
                class="w-full px-4 py-3 border border-(--color-blue-400) rounded-xl bg-blue-800/40 text-white placeholder:text-(--color-blue-300) focus:border-(--color-blue-200) focus:ring-0 focus:outline-none focus-visible:outline-2 focus-visible:outline-white focus-visible:outline-offset-2 focus-visible:rounded-none transition-colors duration-200"
                required
                placeholder="Doe"
                minlength="2"
                maxlength="50"
              />
            </div>
          </div>

          {/* Work Email */}
          <div class="space-y-2">
            <label for="workEmail" class="block text-(--color-blue-100) text-sm font-medium">
              Work Email <span class="text-(--color-blue-200)">*</span>
            </label>
            <input
              type="email"
              id="workEmail"
              name="workEmail"
              autocomplete="email"
              class="w-full px-4 py-3 border border-(--color-blue-400) rounded-xl bg-blue-800/40 text-white placeholder:text-(--color-blue-300) focus:border-(--color-blue-200) focus:ring-0 focus:outline-none focus-visible:outline-2 focus-visible:outline-white focus-visible:outline-offset-2 focus-visible:rounded-none transition-colors duration-200"
              required
              placeholder="john.doe@company.com"
            />
          </div>

          {/* GDPR Consent */}
          <GDPRConsent
            purpose="providing your requested download"
            formId="download-form"
            id="download-gdpr-consent"
            variant="download"
          />

          {/* Privacy Notice */}
          <div class="pt-4 border-t border-(--color-blue-500)">
            <p class="text-xs text-(--color-blue-100) leading-relaxed">
              By submitting this form, you agree to receive marketing communications from Webstack
              Builders. You can unsubscribe at any time. View our
              <a
                href="/privacy"
                class="text-white underline hover:text-(--color-blue-100) focus:outline-none focus:ring-2 focus:ring-white focus:ring-offset-2 focus:ring-offset-(--color-blue-600) rounded"
              >
                Privacy Policy
              </a>.
            </p>
          </div>

          {/* Submit Button */}
          <Confetti>
            <div class="pt-2">
              <button
                type="submit"
                class="w-full bg-white text-blue-700 font-semibold py-3 px-6 rounded-xl hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-white focus:ring-offset-2 focus:ring-offset-(--color-blue-600) transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                id="downloadSubmitBtn"
              >
                Download Now
              </button>
            </div>
          </Confetti>

          {/* Download Button (hidden until form is successfully submitted) */}
          <div class="pt-2 hidden" id="downloadButtonWrapper">
            <a
              href={normalizedDownloadUrl}
              target="_blank"
              rel="noopener noreferrer"
              class="block w-full bg-(--color-green-600) text-white font-semibold py-3 px-6 rounded-xl hover:bg-(--color-green-700) focus:outline-none focus:ring-2 focus:ring-(--color-green-600) focus:ring-offset-2 transition-all duration-200 text-center"
              id="downloadBtn"
            >
              <Icon icon="download-document" color="inherit" size={5} classes="inline-block mr-2 -mt-1" />
              Download {fileType}
            </a>
          </div>

          {/* Status Messages */}
          <div
            id="downloadFormStatus"
            class="hidden p-4 rounded-xl text-sm"
            role="status"
            aria-live="polite"
            aria-atomic="true"
          >
          </div>
        </form>
      </div>
    </div>{/* end right column */}
  </div>{/* end two-column grid */}
</download-form>

<script>
  import { registerDownloadFormWebComponent } from '@components/Pages/Downloads/client'
  registerDownloadFormWebComponent()
</script>
