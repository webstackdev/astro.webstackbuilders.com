---
// Testimonials component for displaying client testimonials
// Refactored to use Embla Carousel for consistency with other carousel components
import { getCollection } from 'astro:content'
import Icon from '@components/Icon/index.astro'
import Card from './Card.astro'
import type { TestimonialsProps } from './@types'

export type { TestimonialsProps as Props } from './@types'

const {
  title = 'Testimonials',
  leadText,
  limit,
  count,
  organization,
  showControls = true,
} = Astro.props as TestimonialsProps

// Get all testimonials from content collection
const allTestimonials = await getCollection('testimonials')

const normalizeOrganization = (value: unknown): string =>
  String(value ?? '')
    .trim()
    .toLowerCase()

const organizationFilter = normalizeOrganization(organization)

const filteredTestimonials = organizationFilter
  ? allTestimonials.filter(entry => normalizeOrganization(entry.data.organization) === organizationFilter)
  : allTestimonials

const sortByOrganizationThenDate = (a: (typeof allTestimonials)[number], b: (typeof allTestimonials)[number]) => {
  const orgA = String(a.data.organization ?? '')
  const orgB = String(b.data.organization ?? '')

  const organizationCompare = orgA.localeCompare(orgB, undefined, { sensitivity: 'base' })
  if (organizationCompare !== 0) {
    return organizationCompare
  }

  return new Date(b.data.publishDate).getTime() - new Date(a.data.publishDate).getTime()
}

const resolvedLimit = limit ?? count

// Sort by organization (stable grouping), then newest first. Apply optional limit.
const testimonials = filteredTestimonials
  .sort(sortByOrganizationThenDate)
  .slice(0, resolvedLimit || filteredTestimonials.length)

const shouldRenderSingle = Boolean(organizationFilter) && testimonials.length === 1
const headingId = `testimonials-${organizationFilter ? organizationFilter.replace(/[^a-z0-9]+/g, '-') : 'all'}-title`
const singleTestimonial = shouldRenderSingle ? testimonials.at(0) : undefined
---

{
  testimonials.length > 0 &&
    (shouldRenderSingle ? (
      <div class="bg-page-offset max-w-6xl mx-auto px-4 sm:px-6 lg:px-8" aria-labelledby={headingId}>
        <header class="text-center mb-6">
          <h2 id={headingId} class="text-3xl md:text-4xl font-bold mb-4">{title}</h2>
          {leadText && (
            <p class="text-xl text-content-active max-w-3xl mx-auto">{leadText}</p>
          )}
        </header>

        <div class="max-w-4xl mx-auto">
          {singleTestimonial && <Card testimonial={singleTestimonial} />}
        </div>
      </div>
    ) : (
      <testimonials-carousel
        data-carousel
        class="block"
        role="region"
        aria-roledescription="carousel"
        aria-label={title}
        aria-labelledby={headingId}
      >
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 pb-4 md:pb-6 lg:pb-8">
          <header class="mb-6">
            <h2 id={headingId} class="font-sans text-lg font-bold text-primary uppercase tracking-widest">
              {title}
            </h2>
            {leadText && (
              <p class="text-center text-xl text-content-active max-w-3xl mx-auto">{leadText}</p>
            )}
          </header>

          {/* Embla Carousel for Testimonials */}
          <div class="testimonials-embla relative">
            <div class="embla__viewport overflow-hidden">
              <div class="embla__container flex">
                {testimonials.map((testimonial, index) => (
                  <div
                    class="embla__slide flex-[0_0_100%] min-w-0 px-4"
                    data-testimonials-slide
                    role="group"
                    aria-roledescription="slide"
                    aria-label={`Testimonial ${index + 1} of ${testimonials.length}`}
                  >
                    <Card testimonial={testimonial} />
                  </div>
                ))}
              </div>
            </div>

            {/* Navigation Buttons */}
            {testimonials.length > 1 && (
              <>
                <button
                  type="button"
                  class="embla__button embla__button--prev absolute left-0 top-1/2 -translate-y-1/2 -translate-x-4 w-12 h-12 rounded-full bg-content-inverse border-2 border-trim shadow-lg hover:bg-gray-200 hover:border-gray-200 transition-all duration-300 flex items-center justify-center z-(--z-raised) disabled:opacity-30 disabled:cursor-not-allowed focus-visible:outline-none after:pointer-events-none after:absolute after:-inset-0.5 after:rounded-none after:content-[''] focus-visible:after:border-2 focus-visible:after:border-spotlight"
                  aria-label="Previous testimonial"
                >
                  <svg
                    class="w-6 h-6"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                    aria-hidden="true"
                    focusable="false"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M15 19l-7-7 7-7"
                    />
                  </svg>
                </button>

                <button
                  type="button"
                  class="embla__button embla__button--next absolute right-0 top-1/2 -translate-y-1/2 translate-x-4 w-12 h-12 rounded-full bg-content-inverse border-2 border-trim shadow-lg hover:bg-gray-200 hover:border-gray-200 transition-all duration-300 flex items-center justify-center z-(--z-raised) disabled:opacity-30 disabled:cursor-not-allowed focus-visible:outline-none after:pointer-events-none after:absolute after:-inset-0.5 after:rounded-none after:content-[''] focus-visible:after:border-2 focus-visible:after:border-spotlight"
                  aria-label="Next testimonial"
                >
                  <svg
                    class="w-6 h-6"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                    aria-hidden="true"
                    focusable="false"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9 5l7 7-7 7"
                    />
                  </svg>
                </button>

                {showControls && (
                  <div class="mt-8 flex items-center justify-center gap-3">
                    <div
                      class="embla__dots flex gap-2 justify-center"
                      role="group"
                      aria-label="Testimonial navigation"
                    />
                      <button
                        type="button"
                        class="relative flex items-center justify-center rounded-full border border-trim bg-content-inverse p-1 shadow-lg transition-colors hover:bg-page-offset focus-visible:outline-none after:pointer-events-none after:absolute after:-inset-0.5 after:rounded-none after:content-[''] focus-visible:after:border-2 focus-visible:after:border-spotlight"
                        data-testimonials-autoplay-toggle
                        aria-label="Pause testimonials"
                        aria-pressed="false"
                      >
                        <span data-testimonials-icon="pause">
                          <Icon icon="pause" size={20} />
                        </span>
                        <span data-testimonials-icon="play" class="hidden">
                          <Icon icon="play" size={20} />
                        </span>
                      </button>
                  </div>
                )}
              </>
            )}
          </div>
        </div>
      </testimonials-carousel>
    ))
}

{!shouldRenderSingle && (
  <script>
    import { registerTestimonialsWebComponent } from '@components/Testimonials/client'
    registerTestimonialsWebComponent()
  </script>
)}
