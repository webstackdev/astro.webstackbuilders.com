---
// Testimonials component for displaying client testimonials
// Refactored to use Embla Carousel for consistency with other carousel components
import { getCollection } from 'astro:content'
import Avatar from '@components/Avatar/index.astro'

export interface Props {
  title?: string
  limit?: number
}

const { title = 'Testimonials', limit } = Astro.props

// Get all testimonials from content collection
const allTestimonials = await getCollection('testimonials')

// Sort by publishDate (newest first) and apply limit if specified
const testimonials = allTestimonials
  .sort((a, b) => new Date(b.data.publishDate).getTime() - new Date(a.data.publishDate).getTime())
  .slice(0, limit || allTestimonials.length)
---

{
  testimonials.length > 0 && (
    <section class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
      <header class="text-center mb-12">
        <h2 class="text-3xl md:text-4xl font-bold text-[color:var(--color-text)]">{title}</h2>
      </header>

      {/* Embla Carousel for Testimonials */}
      <div class="testimonials-embla relative">
        <div class="embla__viewport overflow-hidden">
          <div class="embla__container flex">
            {testimonials.map(testimonial => (
              <div class="embla__slide flex-[0_0_100%] min-w-0 px-4">
                <article class="bg-[color:var(--color-bg-offset)] rounded-xl p-8 shadow-lg border border-[color:var(--color-border)] h-full flex flex-col">
                  {/* Quote Icon */}
                  <div class="text-[color:var(--color-primary)] mb-4">
                    <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M14.017 21v-7.391c0-5.704 3.731-9.57 8.983-10.609l.995 2.151c-2.432.917-3.995 3.638-3.995 5.849h4v10h-9.983zm-14.017 0v-7.391c0-5.704 3.748-9.57 9-10.609l.996 2.151c-2.433.917-3.996 3.638-3.996 5.849h4v10h-10z" />
                    </svg>
                  </div>

                  {/* Testimonial Content */}
                  <div class="flex-1 mb-6">
                    <blockquote class="text-lg leading-relaxed text-[color:var(--color-text)] italic">
                      {testimonial.body}
                    </blockquote>
                  </div>

                  {/* Author Info */}
                  <div class="flex items-center gap-4">
                    <Avatar name={testimonial.data.name} class="flex-shrink-0" />
                    <div>
                      <div class="font-semibold text-[color:var(--color-text)]">
                        {testimonial.data.name}
                      </div>
                      <div class="text-sm text-[color:var(--color-text-offset)] capitalize">
                        {testimonial.data.organization}
                      </div>
                    </div>
                  </div>
                </article>
              </div>
            ))}
          </div>
        </div>

        {/* Navigation Buttons */}
        {testimonials.length > 1 && (
          <>
            <button
              type="button"
              class="embla__button embla__button--prev absolute left-0 top-1/2 -translate-y-1/2 -translate-x-4 w-12 h-12 rounded-full bg-[color:var(--color-bg)] border-2 border-[color:var(--color-border)] shadow-lg hover:bg-[color:var(--color-primary)] hover:border-[color:var(--color-primary)] hover:text-white transition-all duration-300 flex items-center justify-center z-10 disabled:opacity-30 disabled:cursor-not-allowed"
              aria-label="Previous testimonial"
            >
              <svg
                class="w-6 h-6 text-[color:var(--color-text)]"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 19l-7-7 7-7"
                />
              </svg>
            </button>

            <button
              type="button"
              class="embla__button embla__button--next absolute right-0 top-1/2 -translate-y-1/2 translate-x-4 w-12 h-12 rounded-full bg-[color:var(--color-bg)] border-2 border-[color:var(--color-border)] shadow-lg hover:bg-[color:var(--color-primary)] hover:border-[color:var(--color-primary)] hover:text-white transition-all duration-300 flex items-center justify-center z-10 disabled:opacity-30 disabled:cursor-not-allowed"
              aria-label="Next testimonial"
            >
              <svg
                class="w-6 h-6 text-[color:var(--color-text)]"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 5l7 7-7 7"
                />
              </svg>
            </button>

            {/* Dots Navigation */}
            <div
              class="embla__dots flex gap-2 justify-center mt-8"
              role="group"
              aria-label="Testimonial navigation"
            />
          </>
        )}
      </div>
    </section>
  )
}

<script>
  import { registerScript } from '@components/Scripts/loader'
  import { TestimonialsCarousel } from './client'

  // Register testimonials carousel script to initialize with delayed loading
  registerScript(TestimonialsCarousel)
</script>
