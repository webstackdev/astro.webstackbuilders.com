---
/*!
 * Mastodon Share Modal
 *
 * SPDX-FileCopyrightText: Â© 2025 Kevin Brown <kevin@webstackbuilders.com>
 * SPDX-License-Identifier: AGPL-3.0-only
 */

interface Props {
  id?: string
}

const { id = 'mastodon-modal' } = Astro.props
---

<div
  id={id}
  class="fixed inset-0 z-[9999] flex items-center justify-center p-4"
  role="dialog"
  aria-modal="true"
  aria-labelledby="modal-title"
  hidden
>
  <div class="modal-backdrop absolute inset-0 bg-black/50 backdrop-blur-sm"></div>
  <div
    class="modal-content relative w-full max-w-2xl max-h-[90vh] overflow-auto bg-[var(--color-bg)] rounded-lg shadow-2xl"
  >
    <div class="flex items-center justify-between p-6 border-b border-[var(--color-border)]">
      <h2 id="modal-title" class="m-0 text-xl font-semibold">Share to Mastodon</h2>
      <button
        type="button"
        class="modal-close flex items-center justify-center w-8 h-8 p-0 border-0 bg-transparent rounded text-[var(--color-text-muted)] cursor-pointer transition-all duration-150 hover:bg-[var(--color-bg-muted)] hover:text-[var(--color-text)]"
        aria-label="Close modal"
      >
        <svg
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <path d="M18 6L6 18M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <form id="mastodon-share-form" class="flex flex-col gap-6 p-6">
      <!-- Share Text -->
      <div class="flex flex-col gap-2">
        <label for="share-text" class="font-medium">Text to share</label>
        <textarea
          id="share-text"
          name="text"
          rows="4"
          readonly
          class="w-full p-3 border border-[var(--color-border)] rounded-md bg-[var(--color-bg-muted)] font-[inherit] text-sm leading-6 resize-y focus:outline-2 focus:outline-[var(--color-primary)] focus:outline-offset-2"
        ></textarea>
      </div>

      <!-- Instance Selector (inlined from InstanceSelector.astro) -->
      <div class="flex flex-col gap-4">
        <label for="mastodon-instance" class="flex flex-col gap-2 font-medium">
          <span>Mastodon Instance</span>
          <div
            class="flex items-stretch border border-[var(--color-border)] rounded-md overflow-hidden bg-[var(--color-bg-input)] focus-within:outline-2 focus-within:outline-[var(--color-primary)] focus-within:outline-offset-2"
          >
            <span
              class="flex items-center px-3 py-2 bg-[var(--color-bg-muted)] text-[var(--color-text-muted)] text-sm select-none"
              aria-label="https prefix"
              id="instance-prefix"
            >
              https://
            </span>
            <input
              type="text"
              id="mastodon-instance"
              name="instance"
              placeholder="mastodon.social"
              required
              aria-describedby="instance-prefix"
              class="flex-1 min-w-0 px-3 py-2 border-0 bg-transparent text-base text-[var(--color-text)] focus:outline-none"
            />
          </div>
        </label>

        <!-- Saved Instances -->
        <div id="saved-instances" class="flex flex-col gap-2" style="display: none;">
          <p class="m-0 text-sm font-medium text-[var(--color-text-muted)]">Previously used:</p>
          <div class="saved-list flex flex-wrap gap-2"></div>
        </div>

        <!-- Remember Instance Checkbox -->
        <label for="remember-instance" class="flex items-center gap-2 text-sm cursor-pointer">
          <input type="checkbox" id="remember-instance" name="remember" class="w-4 h-4 cursor-pointer" />
          <span>Remember this instance</span>
        </label>
      </div>

      <!-- Action Buttons -->
      <div class="flex gap-3 justify-end">
        <button
          type="button"
          class="btn-secondary modal-cancel px-4 py-2 border border-[var(--color-border)] rounded-md font-medium cursor-pointer transition-all duration-150 bg-transparent text-[var(--color-text)] hover:bg-[var(--color-bg-muted)]"
        >
          Cancel
        </button>
        <button
          type="submit"
          class="btn-primary px-4 py-2 border-0 rounded-md font-medium cursor-pointer transition-all duration-150 bg-[var(--color-primary)] text-white hover:bg-[var(--color-primary-dark)] disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Share
        </button>
      </div>

      <!-- Status Message -->
      <p class="modal-status m-0 text-sm text-center" role="status" aria-live="polite"></p>
    </form>
  </div>
</div>

<style>
  /* Additional styles for saved instance buttons (created dynamically) */
  .saved-list :global(.saved-instance) {
    padding: 0.25rem 0.5rem;
    background: var(--color-bg-muted);
    border: 1px solid var(--color-border);
    border-radius: 0.25rem;
    font-size: 0.875rem;
    color: var(--color-primary);
    cursor: pointer;
    transition: all 0.15s ease;
  }

  .saved-list :global(.saved-instance:hover) {
    background: var(--color-primary);
    color: var(--color-bg);
  }

  /* Status message states */
  .modal-status.error {
    color: var(--color-error);
  }

  .modal-status.success {
    color: var(--color-success);
  }
</style>

<script>
  import { registerScript } from '@components/Scripts/loader'
  import { MastodonModal } from './client'

  registerScript(MastodonModal)
</script>
