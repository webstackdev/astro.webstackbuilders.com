---
/**
 * Social Media Embed Component
 * Supports multiple platforms with lazy loading and oEmbed integration
 *
 * Supported platforms:
 * - X (Twitter)
 * - LinkedIn (requires embed code from post menu)
 * - Bluesky (requires explicit platform prop)
 * - Mastodon
 * - YouTube
 * - GitHub Gist
 * - CodePen
 *
 * Usage in MDX:
 *
 * Auto-detection (X, YouTube, GitHub Gist, CodePen, Mastodon):
 * <Embed url="https://twitter.com/user/status/123456789" />
 *
 * Explicit platform (Bluesky):
 * <Embed url="https://bsky.app/profile/user.bsky.social/post/123abc" platform="bluesky" />
 *
 * LinkedIn (paste embed code from post's "Embed this post" option):
 * <Embed platform="linkedin" url="https://www.linkedin.com/embed/feed/update/...">
 * <iframe src="https://www.linkedin.com/embed/feed/update/..." height="593" width="504" frameborder="0" allowfullscreen="" title="Embedded post"></iframe>
 * </Embed>
 */

import type { EmbedPlatform } from '@components/Social/Embed/client'
import './index.css'

type EmbedType = EmbedPlatform | 'gist'

export interface Props {
  url: string
  platform?: EmbedPlatform
  /** Alias for platform (backwards-compat for `type` usage in content). */
  type?: EmbedType
  /** Optional iframe dimensions for media platforms (e.g., YouTube). */
  width?: number
  /** Optional iframe dimensions for media platforms (e.g., YouTube). */
  height?: number
  className?: string
}

const { url, platform, type, width: widthProp, height: heightProp, className = '' } = Astro.props

const normalizeEmbedPlatform = (value: EmbedType | undefined): EmbedPlatform | undefined => {
  if (!value) return undefined
  if (value === 'gist') return 'github-gist'
  return value
}

const requestedPlatform = normalizeEmbedPlatform(platform) ?? normalizeEmbedPlatform(type)

const youtubeDefaults = { width: 560, height: 315 }
const resolvedWidth =
  typeof widthProp === 'number'
    ? widthProp
    : requestedPlatform === 'youtube'
      ? youtubeDefaults.width
      : undefined
const resolvedHeight =
  typeof heightProp === 'number'
    ? heightProp
    : requestedPlatform === 'youtube'
      ? youtubeDefaults.height
      : undefined

// Determine the platform for placeholder styling
const detectedPlatform = requestedPlatform || 'x' // Default to X for auto-detection

// Platform-specific max-width classes
const platformMaxWidth: Record<string, string> = {
  youtube: 'max-w-[640px]',
  codepen: 'max-w-[640px]',
  'github-gist': 'max-w-full font-mono',
}
const maxWidthClass = platformMaxWidth[detectedPlatform] || 'max-w-[550px]'
---

<social-embed
  class={`my-8 mx-auto ${maxWidthClass} ${className}`}
  url={url}
  platform={requestedPlatform}
  data-embed-width={resolvedWidth}
  data-embed-height={resolvedHeight}
>
  {requestedPlatform === 'linkedin' ? <slot /> : null}
</social-embed>

<script>
  import { socialEmbedDataConsentRevokeListener } from '@components/scripts/store'
  import { EmbedManager } from '@components/Social/Embed/client'
  import { registerWebComponent } from '@components/Social/Embed/client/webComponent'

  registerWebComponent()
  // Initialize embed manager with Astro View Transitions
  document.addEventListener('astro:page-load', () => {
    EmbedManager.init()
    socialEmbedDataConsentRevokeListener()
  })
</script>
