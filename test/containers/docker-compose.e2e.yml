name: wb-e2e-mocks

services:
  convertkit-mock:
    image: wiremock/wiremock:3.6.0
    container_name: ${COMPOSE_PROJECT_NAME:-wb}-convertkit-mock
    restart: unless-stopped
    environment:
      - JAVA_OPTS=-XX:MaxRAMPercentage=75.0
    command:
      - "--verbose"
      - "--port=8080"
      - "--global-response-templating"
    ports:
      - "${CONVERTKIT_HTTP_PORT:-9010}:8080"
    volumes:
      - ./convertkit/mappings:/home/wiremock/mappings:ro
      - ./convertkit/__files:/home/wiremock/__files:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/__admin/mappings"]
      interval: 10s
      timeout: 5s
      retries: 6
    networks:
      - e2e-mocks

  resend-mock:
    image: wiremock/wiremock:3.6.0
    container_name: ${COMPOSE_PROJECT_NAME:-wb}-resend-mock
    restart: unless-stopped
    environment:
      - JAVA_OPTS=-XX:MaxRAMPercentage=75.0
    command:
      - "--verbose"
      - "--port=8080"
      - "--global-response-templating"
    ports:
      - "${RESEND_HTTP_PORT:-9011}:8080"
    volumes:
      - ./resend/mappings:/home/wiremock/mappings:ro
      - ./resend/__files:/home/wiremock/__files:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/__admin/mappings"]
      interval: 10s
      timeout: 5s
      retries: 6
    networks:
      - e2e-mocks

  upstash-redis-db:
    image: redis:7.4-alpine
    container_name: ${COMPOSE_PROJECT_NAME:-wb}-upstash-redis-db
    restart: unless-stopped
    command: ["redis-server", "--save", "", "--appendonly", "no"]
    ports:
      - "${UPSTASH_REDIS_PORT:-6380}:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 6
    networks:
      - e2e-mocks

  upstash-redis:
    image: wb/upstash-redis-local:test
    container_name: ${COMPOSE_PROJECT_NAME:-wb}-upstash-redis
    restart: unless-stopped
    command:
      - "--token"
      - "${UPSTASH_TOKEN:-local-dev-token}"
      - "--addr"
      - ":${UPSTASH_HTTP_PORT:-8079}"
      - "--redis"
      - "upstash-redis-db:6379"
    ports:
      - "${UPSTASH_HTTP_PORT:-8079}:${UPSTASH_HTTP_PORT:-8079}"
    healthcheck:
      test:
        - CMD-SHELL
        - >-
          curl -fsS -H "Authorization: Bearer ${UPSTASH_TOKEN:-local-dev-token}" -H "Content-Type: application/json" --data '["PING"]' http://127.0.0.1:${UPSTASH_HTTP_PORT:-8079}/ >/dev/null
      interval: 10s
      timeout: 5s
      retries: 6
    networks:
      - e2e-mocks

  upstash-seed:
    image: redis:7.4-alpine
    container_name: ${COMPOSE_PROJECT_NAME:-wb}-upstash-seed
    depends_on:
      upstash-redis-db:
        condition: service_healthy
    environment:
      REDIS_HOST: upstash-redis-db
      REDIS_PORT: "6379"
      REDIS_TOKEN: ${UPSTASH_TOKEN:-local-dev-token}
    volumes:
      - ./upstash/seed.sh:/scripts/seed.sh:ro
      - ./upstash/seeds:/seeds:ro
    entrypoint: ["/bin/sh", "/scripts/seed.sh"]
    networks:
      - e2e-mocks

networks:
  e2e-mocks:
    driver: bridge
