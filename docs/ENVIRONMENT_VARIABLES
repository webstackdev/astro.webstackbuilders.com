# Environment variables

## CI / CD

Install Vercel CLI if not already done. Linking it will create a .vercel directory in the project with local configuration details. This directory is gitignored.

```bash
npm install -g vercel
vercel link
```

Pull env vars from Vercel:

```bash
vercel env pull .env
```

See [Deployment](./DEPLOYMENT_SETUP.md) for information on adding environment variables to the GitHub repository for use in workflow Actions.

## Loading

Astro uses Vite to load environment variables, which in turn uses `dotenv` to load them from several `.env` files located in the project's root directory. The specific files loaded, and their priority, depend on the current mode (development or production). All `.env*` files are gitignored.

- `.env`: Loaded in all cases, providing general environment variables.
- `.env.local`: Loaded in all cases, intended for local development settings.
- `.env.[mode]`: Loaded only in the specified mode (`.env.development` when running the Astro dev server, and `.env.production` when running `astro build`).
- `.env.[mode].local`: Loaded only in the specified mode, providing local overrides for a specific mode.

## Availability

1. Auto-loaded environment variables are not available in **config files**. The files are excluded from the ESLint linting rule forbidding `process.env`. They can use Vite's `loadEnv()` method to load `.env*` files.
2. All environment variables are available in **server-side code**.
3. Only environment variables prefixed with `PUBLIC_` are available in **client-side code**. Vite extracts these variables from `.env*` files during loading and bundles them into the client script.

## Typing

There are two ways in an Astro project to type environmental variables in Astro:

1. Add them to `src/lib/config/environmentalVariableValidation.ts`. This provides validation for the variables. Astro will generate a `.astro/env.d.ts` file with the types exported as `const` from `astro sync`, ran automatically on `astro dev` and `astro build`. They will be available as tokens from `astro:env/server` and `astro:env/client` respectively.
2. Add them to `src/env.d.ts`. This will provide TypeScript typing for intellisense but no validation. Environmental variables added this way will not be made available on the `astro:env` imports.

## Use in Code

Import environment variables defined in `environmentalVariableValidation` directly.

All variables:

```typescript
import { ENV_VAR } from 'astro:env/server'
```

Client side variables:

```typescript
import { PUBLIC_ENV_VAR } from 'astro:env/client'
```

The `process.env` and `import.meta.env` methods of accessing environment variables will generate linting errors if used outside of the root-level configuration files where they are necessary.

## Determining Site URL

The site URL can vary based on whether code is being ran from the Astro dev server, being ran in production (including being ran with `astro serve`), being ran from Vitest in unit files,

- Use the `getSiteUrl()` method from `src/components/scripts/utils/siteUrlClient.ts` to determine the site URL in **client code**.
- Use the `getSiteUrl()` method from `src/lib/config/siteUrlServer.ts` to determine the site URL in **server code**.

## Determining Mode

Use well tested methods to determine what mode (dev, prod, ci, vitest, playwright) code is operating in:

- Use methods in `src/components/scripts/utils/environmentClient.ts` to determine mode in **client code**.
- Use  methods in `src/lib/config/environmentServer.ts` to determine mode in **server code**.
