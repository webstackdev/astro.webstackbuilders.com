# Runs lint checks and a green build to gate deployments
name: Lint

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions: {}

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    environment: testing
    if: ${{ !startsWith(github.head_ref || github.ref_name, 'hotfix/') }}

    permissions:
      contents: read

    env:
      DISABLE_TELEMETRY: true
      FORCE_COLOR: 3
      # Public client vars required by Astro env validation
      PUBLIC_GOOGLE_MAPS_API_KEY: ${{ vars.PUBLIC_GOOGLE_MAPS_API_KEY }}
      PUBLIC_GOOGLE_MAP_ID: ${{ vars.PUBLIC_GOOGLE_MAP_ID }}
      PUBLIC_SENTRY_DSN: ${{ vars.PUBLIC_SENTRY_DSN }}
      PUBLIC_UPSTASH_SEARCH_READONLY_TOKEN: ${{ vars.PUBLIC_UPSTASH_SEARCH_READONLY_TOKEN }}
      PUBLIC_UPSTASH_SEARCH_REST_URL: ${{ vars.PUBLIC_UPSTASH_SEARCH_REST_URL }}
      # Server secret required by Astro env validation
      WEBMENTION_IO_TOKEN: ${{ vars.WEBMENTION_IO_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6.0.2

      - name: Setup Python
        uses: actions/setup-python@v6.2.0
        with:
          python-version: '3.13'
          cache: 'pip'

      - name: Install Python dependencies
        run: python3 -m pip install -r requirements.txt

      - name: Setup Node.js
        uses: actions/setup-node@v6.2.0
        with:
          node-version: '22.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --force

      - name: Run lint
        run: npm run lint

      - name: Run Astro Check
        run: npm run check

  hotfix-bypass:
    name: Lint Hotfix Bypass
    runs-on: ubuntu-latest
    if: ${{ startsWith(github.head_ref || github.ref_name, 'hotfix/') }}

    permissions: {}

    steps:
      - name: Skip lint for hotfix branch
        run: echo "hotfix/* branch detected; skipping lint but allowing deployments."

