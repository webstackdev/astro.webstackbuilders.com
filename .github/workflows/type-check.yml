# Fast code quality checks (TypeScript + Linting)
name: Code Quality Check

on:
  push:
  pull_request:
    branches: [main]

jobs:
  quality-check:
    name: Code Quality Check
    runs-on: ubuntu-latest

    # Define environment variables once at the job level
    # These will be available to ALL steps in this job
    # @TODO: Same issue with build-and-test.yml. These are real keys set on GitHub. But the production build only occurs on Vercel, and it's the only place that needs real keys. Once we set up a test framework using Docker containers for Suprabase, Upstash, etc., we should replace these keys with test keys.
    env:
      CONVERTKIT_API_KEY: ${{ secrets.CONVERTKIT_API_KEY }}
      CONVERTKIT_FORM_ID: ${{ secrets.CONVERTKIT_FORM_ID }}
      CRON_SECRET: ${{ secrets.CRON_SECRET }}
      RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
      SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
      SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      KV_URL: ${{ secrets.KV_URL }}
      KV_REST_API_URL: ${{ secrets.KV_REST_API_URL }}
      KV_REST_API_TOKEN: ${{ secrets.KV_REST_API_TOKEN }}
      KV_REST_API_READ_ONLY_TOKEN: ${{ secrets.KV_REST_API_READ_ONLY_TOKEN }}
      REDIS_URL: ${{ secrets.REDIS_URL }}
      WEBMENTION_IO_TOKEN: ${{ secrets.WEBMENTION_IO_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.x"
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Run TypeScript check
        run: npm run check

      - name: Run linting
        run: npm run lint