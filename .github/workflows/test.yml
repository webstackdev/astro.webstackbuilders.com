# Runs unit tests to gate deployments
name: Test

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions: {}

jobs:
  unit-test:
    name: Unit Tests
    runs-on: ubuntu-latest
    environment: testing
    if: ${{ !startsWith(github.head_ref || github.ref_name, 'hotfix/') }}

    permissions:
      actions: write
      checks: write
      contents: read
      pull-requests: write

    env:
      ASTRO_DB_APP_TOKEN: ${{ vars.ASTRO_DB_APP_TOKEN }}
      ASTRO_DB_REMOTE_URL: ${{ vars.ASTRO_DB_REMOTE_URL }}
      COMPOSE_PROJECT_NAME: ${{ vars.COMPOSE_PROJECT_NAME }}
      CONVERTKIT_API_KEY: ${{ vars.CONVERTKIT_API_KEY }}
      CONVERTKIT_HTTP_PORT: ${{ vars.CONVERTKIT_HTTP_PORT }}
      CRON_SECRET: ${{ vars.CRON_SECRET }}
      DEV_SERVER_HOST: 127.0.0.1
      DEV_SERVER_PORT: ${{ vars.DEV_SERVER_PORT }}
      DISABLE_TELEMETRY: true
      FORCE_COLOR: 3
      PUBLIC_GOOGLE_MAPS_API_KEY: ${{ vars.PUBLIC_GOOGLE_MAPS_API_KEY }}
      PUBLIC_GOOGLE_MAP_ID: ${{ vars.PUBLIC_GOOGLE_MAP_ID }}
      PUBLIC_UPSTASH_SEARCH_READONLY_TOKEN: ${{ vars.PUBLIC_UPSTASH_SEARCH_READONLY_TOKEN }}
      PUBLIC_UPSTASH_SEARCH_REST_URL: ${{ vars.PUBLIC_UPSTASH_SEARCH_REST_URL }}
      RESEND_API_KEY: ${{ vars.RESEND_API_KEY }}
      RESEND_HTTP_PORT: ${{ vars.RESEND_HTTP_PORT }}
      SENTRY_AUTH_TOKEN: ${{ vars.SENTRY_AUTH_TOKEN }}
      PUBLIC_SENTRY_DSN: ${{ vars.PUBLIC_SENTRY_DSN }}
      WEBMENTION_IO_TOKEN: ${{ vars.WEBMENTION_IO_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6.0.2

      - name: Setup Node.js
        uses: actions/setup-node@v6.2.0
        with:
          node-version: '22.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --force

      # Astro build runs sync, check, and integrations including verify links
      - name: Verify green build (local DB snapshot)
        run: npm run build:ci

      - name: Run unit tests (Vitest â€” coverage with GitHub Actions reporter)
        id: vitest
        run: npm run test:coverage

      - name: Report Coverage
        if: steps.vitest.outcome == 'success' && hashFiles('coverage/coverage-summary.json') != ''
        # v2.9.0
        uses: davelosert/vitest-coverage-report-action@15b5b41bb7d36796d89f4bf482b09529c53f3446
        with:
          json-summary-path: './coverage/coverage-summary.json'
          json-final-path: './coverage/coverage-final.json'

      - name: Upload test coverage
        if: always() && hashFiles('coverage/coverage-summary.json') != ''
        uses: actions/upload-artifact@v6
        with:
          name: test-coverage
          path: coverage/
          retention-days: 30

  hotfix-bypass:
    name: Hotfix Bypass
    runs-on: ubuntu-latest
    if: ${{ startsWith(github.head_ref || github.ref_name, 'hotfix/') }}

    permissions: {}

    steps:
      - name: Skip testing for hotfix branch
        run: echo "hotfix/* branch detected; skipping lint, unit, and e2e workflows but allowing deployments."

